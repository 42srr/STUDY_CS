# 4. 네트워크

## 4.1 네트워크 개층 개요

### 4.1.1 포워딩과 라우팅 : 데이터 평면과 제어 평면

- 포워딩 (전달)
  - 패킷이 라우터의 입력 링크에 도달했을 때 라우터는 그 패킷을 적절한 출력 링크로 이동시켜야한다.
  - 매우 짧은 시간 (보통 몇 나노초) 단위를 갖기에, 대표적으로 하드웨어에서 실행된다.
- 라우팅
  - 송신자가 수신자에게 패킷을 전송할 때 네트워크 계층은 패킷 경로를 설정해야 한다.
  - 이러한 경로를 계산하는 알고리즘을 라우팅 알고리즘이라 한다.
  - 네트워크 전반에 걸쳐 출발지에서 목적지까지 데이터그램의 종단 간 경로를 결정하는 것이다.
  - 네트워크 라우터에서 필수 불가결한 요소는 포워딩 테이블이다.

#### 제어평면 : 전통적인 접근 방법

- 라우팅 알고리즘은 라우터의 포워딩 테이블의 내용을 결정한다.
- 라우터는 포워딩과 라우팅 기능을 모두 갖고 있어야 한다.

#### 제어 평면 : SDN 접근 방법

- 물리적으로 분리된 (라우터로부터) 원격 컨트롤러 컴퓨터와 각각의 라우터에 의해 사용될 포워딩 테이블을 분배하는 다른 접근법을 보여준다.
- 제어 평면 라우팅 기능이 물리적 라우터와는 다르다. (원격 제어가 포워딩 테이블을 계산 및 배분하는 동안 라우팅 기기는 포워딩만을 수행한다.)
- 포워딩 테이블과 그 밖의 라우팅 정보를 포함한 메시지를 교환함으로써 소통한다.
- 네트워크가 소프트웨어적으로 정의되었을 때, 포워딩 테이블을 계산하는 컨트롤러는 라우터와 상호작용을 하며 소프트웨어에서 실행된다.

### 4.1.2 네트워크 서비스 모델

- 네트워크 서비스 모델은 송수신 호스트 간 패킷 전송 특성을 정의한다.
- 네트워크 계층에서 제공할 수 있는 서비스

  - 보장된 전달 : 패킷이 출발지 호스트에서부터 목적지 호스트까지 도착하는 것을 보장한다.
  - 지연 제한 이내의 보장된 전달 : 패킷의 전달을 보장할 뿐만 아니라 호스트 간의 특성 지연 제한 (예 : 100ms 이내) 안에 전달한다.
  - 순서화 패킷 전달 : 패킷이 목적지에 송신된 순서대로 도착하는 것을 보장한다
  - 최소 대역폭 보장 : 송신과 수신 호스트 사이에 특정한 비트율의 전송링크를 애뮬레이트한다. 송신 호스트가 비트들(패킷의 구성물)을 특정한 비트율 이하로 전송하는 한, 모든 패킷이목적지 호스트까지 전달된다.
  - 보안 서비스 : 네트워크 계층은 모든 데이터그램을 출발지 호스트에서는 암호화, 목적지 호스트에서는 해독을 할 수 있게 하여 트랜스포트 계층의 모든 세그먼트에 대해 기밀성을 유지해야 한다.
- 인터넷 네트워크 계층은 최선형 서비스(best-effort service)라고 알려진 서비스를 제공한다.
- 최선형 서비스는 패킷을 보내는 순서대로 수신됨을 보장할 수 없을 뿐만 아니라 목적지까지의 전송 자체도 보장할 수 없다. 종단 시스템 간 지연 또한 보장되지 않으며, 보장된 최소 대역폭 또한 없다.

#### 4장의 개요

- 라우터 같은 패킷 스위치는 네트워크 계층 필드값에 근거하여 포워딩을 결정한다.

## 4.2 라우터 내부에는 무엇이 있을까?

- 포트라는 용어는 물리적인 입출력 라우터 인터페이스를 의미한다.
- 입력 포트
  - 물리 계층 기능을 수행한다.
  - 들어오는 링크의 반대편에 있는 링크 계층과 상호 운용하기 위해 필요한 링크 계층 기능을 수행한다.
  - 검색 기능을 수행한다.
  - 포워딩 테이블을 참조하여 도착된 패킷이 스위치 구조를 통해 라우터 출력 포트를 결정한다.
  - 제어 패킷(예 : 라우팅 프로토콜 정보를 전달하는 패킷)은 입력 포트에서 라우팅 프로세서로 전달된다
- 스위치 구조
  - 라우터의 입력 포트와 출력 포트를 연결한다.
  - 라우터 내부에 포함되어 있다. (네트워크 라우터의 내부 네트워크)
- 출력 포트
  - 스위치 구조에서 수신한 패킷을 저장하고 필요한 링크 계층 및 물리 계층 기능을 수행하여 출력 링크로 패킷을 전송한다.
  - 링크가 양방향인경우(즉, 양방향을 트래픽을 전달), 출력 포트는 일반적으로 동일한 링크의 입력 포트와 한 쌍을 이룬다.
- 라우팅 프로세서
  - 제어 평면 기능을 수행한다.
  - 기존의 라우터에서는 라우팅 프로토콜을 실행하고 라우팅 테이블과 연결된 링크 상태 정보를 유지 관리하며 라우터의 포워딩 테이블을 계산한다.
  - SDN 라우터에서 라우팅 프로세서는 원격 컨트롤러와 통신하여 원격 컨트롤러에서 계산된 포워딩 테이블 엔트리를 수신하고 라우터의 입력 포트에 이러한 엔트리를 설치한다.
  - 네트워크 관리 기능을 수행한다.
- 목적지 기반 포워딩
- 일반화된 포워딩

### 4.2.1 입력 포트 처리 및 목적지 기반 전송

- 입력 포트에서 수행되는 검색은 라우터 동작의 핵심이다.
- 라우터는 포워딩 테이블을 사용하여 도착 패킷이 스위치 구조를 통해 전달되는 출력 포트를 검색한다.
- 포워딩 테이블은 라우팅 프로세서(다른 네트워크 라우터의 라우팅 프로세ㅐ서와 상호작용하기 위해 라우팅 프로토콜을 사용)에서 계산되거나 갱신되거나 원격 SDN 컨트롤러에서 수신된다.
- 포워딩 테이블은 라우팅 프로세서에서 입력 라인 카드로 복사된다.
- 각 라인 카드에서 이와 같은 섀도 복사본을 사용하면 패킷 단위로 중앙 집중식 라우팅 프로세서를 호출하지 않게 되고 따라서 병목 현상을 피할 수 있다.
- 포워딩 테이블에서 라우터는 패킷의 목적지 주소의 프리픽스를 테이블의 엔트리와 매치한다.
- 다수의 매치가 있을 때 라우터는 최장 프리픽스 매치 규칙을 사용한다.
- 즉 테이블에서 가장 긴 매치 엔트리를 찾고 여기에 연관된 링크 인터페이스로 패킷을 보낸다.

### 4.2.2 스위칭

- 메모리를 통해 교환
  - 가장 단순한 초기의 라우터는 CPU(라우팅 프로세서)를 직접 제어해서 입력 포트와 출력 포트 사이에서 패킷을 스위칭하는 전통적인 컴퓨터다.
  - 패킷이 도착하면 입력 포트는 라우팅 프로세서에게 인터럽트를 보내 패킷을 프로세서 메모리에 복사한다.
  - 그런 다음 라우팅 프로세스는 헤더에서 목적지 주소를 추출하고 포워딩 테이블에서 적절한 출력 포트를 찾은 다음 패킷을 출력 포트의 버퍼에 복사한다.
  - 목적지포트가 다른 경우라도 공유 시스템 버스를 통해 한 번에 하나의 메모리 읽기/쓰기 작업을 수행할 수 있기 때문에 두 패킷을 동시에 전달할 수 없다.
- 버스를 통한 교환
  - 입력 포트는 라우팅 프로세서의 개입 없이공유 버스를 통해 직접 출력 포트로 패킷을 전송한다.
  - 일반적으로 미리 준비된 입력 포트 스위치 내부 레이블(헤더)이 로컬 출력 포트를 나타내는 패킷에게 전송되거나 버스에 패킷을 전송하여 수행된다.
  - 모든 출력 포트에 패킷이 수신되지만 레이블과 매치되는 포트만 패킷을 유지한다.
  - 레이블은 스위치 내에서 버스를 통과하기 위해서만 사용되므로 출력 포트에서 제거된다.
  - 동시에 여러 패킷이 다른 입력 포트에 있는 라우터에 도착하면 한 번에 하나의 패킷만 버스를 통과할 수 있기 때문에 하나를 제외한 모든 패킷이 대기해야 한다.
  - 라우터의 교환 속도는 버스 속도에 의해제한된다.
- 상호연결 네트워크를 통한 교환
  - 크로스바 스위치는 N개의 입력 포트를 N개의 출력 포트에 연결하는 2N 버스로 구성된 상호연결 네트워크다.
  - 각 수직 버스는 교차점에서 각 수평 버스와 교차하며 스위치 구조 컨트롤러에 의해 언제든지열거나 닫을 수 있다.
  - 크로스바 스위치는 여러 패킷을 병렬로 전달할 수 있다.
  - 크로스바 스위치는 출력 포트로 전달되는 패킷을 다른 패킷이 현재 해당되는 출력 포트로 전달되지 않는 한 해당 출력 포트에 도달하는 것을 차단하지 않는다.
  - 그러나 2개의 서로 다른 입력 포트에서 나오는 2개의 패킷이 동일한 출력 포트로 보내지는 경우 한 번에 하나의 패킷만 특정 버스에서 전송될 수 있기 때문에 입력을 기다려야 한다.

### 4.2.3 출력 포트 처리

- 출력 포트 처리는 출력 포트의 메모리에 저장된 패킷을 가져와서 출력 링크를 통해 전송한다.
- 여기에는 전송을 위한 패킷 선택(즉 스케줄링) 및 큐 제거, 필요한 링크 계층 및 물리 계층 전송 기능을 수행하는 것이 포함된다.

### 4.2.4 어디에서 큐잉이 일어날까?

- 패킷 큐는 입력 포트와 출력 포트 모두에서 형성될 수 있다.
- 큐의 위치와 범위(입력 포트 큐 또는 출력 포트 큐)는 트래픽 로드, 스위치 구조의 상대 속도 및 라인 속도에 따라서 달라진다.
- 이큐가 더 커지면 도착하는 패킷을 저장할 수 있는 메모리가 없을 때 패킷 손실이 발생할 수 있다.

#### 입력 큐잉

- 지연 없이 구조를 통해 도착하는 모든 패킷을 전송하기에 스위치 구조가 충분히 빠르지 않으면 로스가 날 수 있다.
- 두 패킷이 같은 출력 큐로 향한다면 이 중 한 패킷은 차단되고 입력 큐에서 기다려야 한다.
- 스위치 구조는 한 번에 하나의 패킷만 지정된 출력 포트로 전송이 가능하다.

#### 출력 큐잉

- 출력 포트는 시간 단위(패킷 전송 시간)에 단일 패킷만을 전송할 수 있기 때문에 N개의 패킷 중에도 하나를 전송할 때 다시 N개의 새로운 패킷이 도착할 수 있다.
- 스위치 구조가 포트라인 속도보다 N배 빠른 경우에도 패킷 큐잉이 출력 포트에서 발생할 수 있다.
- 들어오는 패킷을 저장할 메모리가 충분하지 않을 때 도착한 패킷을 삭제(drop-tail 정책으로 알려져 있음)하거나 이미 대기 중인 하나 이상의 패킷을 제거하여 새로 도착한 패킷을 저장하기 위한 공간을 확보해야 한다.
- 어떤 경우에는 버퍼가 가득 차기 전에 패킷을 삭제(또는 헤더를 마킹하여) 송신자에게 혼잡 신호를 제공하는 것이 바람직할 수 있다.
- 이 마킹은 명시적 혼잡 알림 비트를 사용하여 수행할 수 있다.
- AQM(Active Queue Management)알고리즘으로 알려진 많은 패킷 삭제와 패킷 마킹 정책이 있다.

#### 얼마나 많은 버퍼가 요구되는가?

- 버퍼링이 클수록 라우터가 패킷 도착 속도의 큰 변동을 흡수하여 라우터의 패킷 손실률을 감소시킬 수 있기 때문에 버퍼링이 더 낫다고 생각하는 것보다 버퍽사 클수록 큐잉 지연이 길어진다고 생각하는 편이 낫다.
- 지속적 버퍼잉으로 인한 긴 지연에 대한 위의 시나리오를 버퍼블로트 (bufferbloat, 패킷의 과도한 버퍼링으로 인해 생기는 패킷 교환 네트워크의 높은 대기시간의 원인)라고 하는데 이는 처리량뿐만 아니라 최소 지연도 중요하며 네트워크 가장자리와 네트워크 내 큐에서 송신자 간의 상호작용이 실제로 복잡하고 미묘할 수 있음을 보여준다.

### 4.2.5 패킷 스케줄링

- 라우터에서 일반적으로 사용되는 큐잉처리 방법은 FCFS 방식이다. 흔히 FIFO로 잘 알려져 있다.

#### FIFO

- FIFO(또는 FCFS) 스케줄링 규칙은 출력 링크 큐에 도착한 순서와 동일한 순서로 출력 링크에서 전송할 패킷을 선택한다.
- FIFO에서 패킷은 도착한 순서와 동일한 순서로 나가게 된다.

#### 우선순위 큐잉

- 우선순위 큐잉에서 출력 링크에도착한 패킷은 큐에 도착하면 우선순위 클래스롤 분류된다.
- 실제로 네트워크 오퍼레이터는 네트워크 관리 정보를 운반하는 패킷이 사용자 트래픽보다 우선순위를 수신하도록 큐를 구성할 수 있다.
- 각 우선순위 클래스에는 일반적으로 고유한 큐가 있다.
- 전송할 패킷을 선택할 때 우선순위 큐는 전송 대기 중인 패킷으로 차 있는 상태이고 가장 높은 우선순위 클래스에서 패킷을 전송한다.
- 우선순위가 동일한 패킷들 중에서의 선택은 전형적으로 FIFO 방식으로 행해진다.

#### 라운드 로빈과 WFQ

- 라운드 로빈 큐잉 규칙에서 패킷은 우선순위 큐잉과 같이 클래스로 분류된다.
- 그러나 클래스 간에는 엄격한 서비스 우선순위가 존재하지 않으며, 라운드 로빈 스케줄러가 클레스 간에 서비스를 번갈아 제공한다.
- **작업 보존 큐잉(work-conserving queuing)** 규칙의 경우, 전송을 위해 큐에서 기다리는 패킷이 있다면 링크는 유휴 상태가 되는 것을 허용하지 않는다.
- 작업 보존 라운드 로빈 규칙에서는 클래스에서 패킷을 찾지만 아무것도 찾지 못하면 시퀀스의 다음 클래스를 즉시 검사한다.
- 라우터에서 널리 구현된 라운드 로빈 큐잉의일반화된 형태는 소위 **WFQ(Weighted Fair Queuing)** 규칙이다.
- WFQ는 각 클래스마다 다른 양의 서비스 시간을 부여받는다는 점에서 라운드 로빈과 차이가 있다.

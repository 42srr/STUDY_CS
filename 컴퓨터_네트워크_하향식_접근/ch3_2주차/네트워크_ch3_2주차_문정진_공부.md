# TCP

## 3.5 연결지향형 트랜스포트 : TCP

- 신뢰적인 데이터 전송을 제공하기 위해 TCP가 오류 검출, 재전송, 누적 확인응답, 타이머, 순서 번호화 확인응답 번호를 위한 헤더 필드를 포함

### 3.5.1 TCP 연결

- TCP
  1. 애플리케이션 프로세스가 데이터를 다른 프로세스에게 보내기 전에 두 프로세스가 서로 '헨드 세이크' 해야하므로 '연결 지향형'임.
- TCP 연결
  1. 회선 교환 네트워크에서와 같은 종단 간의 'TDM' 'FDM'이 아님
  2. 연결은 두 통신 종산 시스템의 TCP에만 존재 -> 상태를 공유하는 논리적인 것.
  3. TCP 프로토콜은 종단 시스템에만 동작하고, 중간의 네트워크 요소에서는 동작하지 않음 -> 중간 네트워크는 TCP 연결 상태 유지 하지 않음.
  4. 중간 라우터는 TCP 연결 전혀 감지하지 못함. -> 데이터그램만 봄.
- 전이중 서비스 (TCP 연결은 해당 서비스를 제공.)
  1. A와 B, TCP 연결 됐다면 애플리케이션 계층 데이터는 B->A, A->B 로 흐를 수 있음.
  2. TCP연결은 단일 송신자, 단일 수신사 사의의 '점대점'
  3. 멀티캐스팅은 불가.
- TCP 연결은 어떻게 설정되는가?
  1.  클라이언트 프로세스 : 연결을 초기화하는 프로세스
  2.  서버 프로세스 : 다른 프로세스
  3.  클라이언트의 트랜스포트 계층은 서버의 TCP와 TCP 연결 설정 진행.
  4.  클라이언트가 TCP 세그먼트 전송
  5.  서버는 특별한 세그먼트로 응답
  6.  클라이언트가 세 번째 세그먼트 전송
  7.  3 ~ 6까지의 절차를 'three-way handshake'라 부름
- TCP 데이터
  1.  송신 버퍼 : 데이터를 묶음으로 만들어 네트워크에 보냄
  2.  최대 세그먼트 크기(MSS) : 세그먼트를 모아 담을 수 있는 최대 데이터의 양, MSS는 최대 전송 단위에 의해 크기가 결정됨.
  3.  TCP 세그먼트 : TCP헤더와 클라이언트 데이터를 하나로 짝이어 구성.

### 3.5.2 TCP 세그먼트 구성

- TCP 세그먼트 구조
  1.  헤더
      출발지와 목적지 포트 번호를 포함하고, 체크섬 필드를 포함
  2.  순서 번호 필드(32비트), 확인 응답 번호 필드(32비트)
      신뢰적인 데이터 전송 서비스 구현 TCP 송신자와 수신자의해 사용
  3.  수신 윈도(16비트)
      흐름 제어 사용.
      수신자가 받아드리려는 바이트 크기.
  4.  헤더 길이 필드 (4비트)
      32비트 워드 단위로 TCP 헤더의 길이 나타냄
  5.  옵션 필드
      송신자와 수신자가 최대 세그먼트 크기 협상 및 고속 네트워크 사용을 위한 윈도 확자에 사용.
  6.  플래그 필드
      ACK : 세그먼트 송수신이 제대로 됐는지
      RST, SYN, FIN : 연결 설정과 해제
      PSH : 수신자 데이터 상위 계층에 즉시 전달행할 때. '긴급'

#### 순서번호와 확인응답 번호

- TCP 세그먼트 헤더에 가장 중요한 필드 두가지는 순서번호와 확인 응답 필드임.
- TCP 데이터는 구조화 되어 있지 않고, 순서로 정렬되어 있는 바이트 스트림
- TCP 순서 번호 사용은 전송된 바이트의 스크림 관점을 반영
- 세그먼트에 대한 순서 번호 : 세그먼트에 있는 첫 번째 바이트의 바이트 스트림 번호.
- 수신 받은 테이터는 도착한 각 세그먼트는 들어온 데이터 순서 번호를 갖음.

#### 텔넷 : 순서 번호와 응답확인 번호 사례연구

### 3.5.3 왕복 시간(RTT) 예측과 타임아웃

- 타임 아웃은 세그먼트가 전송된 시간부터 긍정 확인응답 될 때까지의 시간인 왕복 시간보타 커야함.

#### 왕복 시간 예측

- SampleRTT= 세그먼트에 대한 RTT 샘플 세그먼트가 송신된 시간으로부터 그 세그먼트가 긍정응답이 도착한 시간.
- TCP는 한 번에 하나의 SamleRTT 측정.
- 확인응답이 없는 세그먼트 중 하나에 대해서 측정이되면 대략적인 왕복 시간마다 SampleRTT의 새로운 값 갖음.
- 이전 SampleRTT 계산하지 않고, 한 번 전송된 세그먼트로만 측정.
- RTT 추정하기 위해 SampleRTT의 평균값 계산하고 채택
- EstimatedRTT : SampleRTT 평균값을 유지하고, 긍정 확인응답 획득시 해당 RTT를 갱신.
- EstimatedRTT : SampleRTT의 가중평균

#### 재전송 타임아웃 주기의 설정 관리

- RTT 타임아웃 주기는 EstimetedRTT보다 크거나 같아야함-> 그렇지 않을 경우 불필요한 재전송 발생.
- 또한 해당 값도나 너무 크면 안됨 -> 세그먼트를 잃었을 때, TCP는 즉각적 재전송하지 않음 -> 데이터 전송 지연 나타남.
- 즉 타임아웃 값은 EstimetedRTT에 여웃값을 더한 값으로 설정해야함.

### 3.5.4 신뢰적인 데이터 전송

- 데이터그램 전달은 순서대로 전달되는 것을 보장하지 않음.
- 데이터그램에 포함된 데이터의 무결성을 보장하지 않음.
- TCP는 신뢰적인 데이터 전송 서비스 제공.

1. 손실 세그먼트를 복구하기 위한 타임아웃 사용
2. 타임아웃을 추가하여 중복 확인 응답 이용.

#### 몇 가지 흥미로운 시나리오

#### 타임아웃 주기의 두 배로 설정

#### 빠른 재전송

#### GBN인가 SR인가?

- TCP 확인 응답은 누적되고 올바리게 수신 되지만, 순서가 잘못된 세그먼트는 개별적으로 ACK를 받지 않음.
- TCP 송신자는 전송했지만 확인응답 안 된 바이트의 가장 작은 순서 번호와 전송될 다음 바이트 순서본호를 유지해야함.
- 올바르게 수신되었지만, 순서가 바뀐 세그먼트를 버퍼링함.
- 선택적 확인응답 : TCP 수신자가 마지막으로 올바로 수신된 순서가 맞는 세그먼트에 대해 누적응답 하기보다는 순서가 틀린 세그먼트에 대해 선택적으로 확인응답을 하게 됨.

### 3.5.5 흐름 제어

- TCP 연결이 순서대로 올바르게 바이트 수신할 때, TCP는 데이터를 수신 버퍼에 저장.
- 애플리케이션 프로세스는 버퍼에서 데이터를 읽지만, 데이터가 도달한 시점에 읽을 필요 없음.
- 데이터를 읽는 속도가 느리다면, 송신자가 데이터를 빠르게 전송할 때, 수신 버퍼는 오퍼플로우 발생.
- 흐름 제어 서비스 : 해당 오버플로를 방지하기 위해 제공.
- 혼잡 제어 : 읽는 속도와 전송 속도를 동일하게 함.
- 수신 윈도 : 수신 윈도는 가용 버퍼 공간이 얼마나 되는지 송신자에게 보냄. 이를 기반으로 송신자도 버퍼 공간을 맞춤

### 3.5.6 TCP 연결 관리

1. 단계
   클라이언트 측 TCP는 서버 TCP와 특별한 TCP 세그먼트 전송
   해당 세그먼트는 애플리케이션 계층 데이터를 포함하지 않음
   SYN비트라고 불리는 하나의 플래그 비트를 1로 설정
2. 단계
   TCP SYN 세그먼트를 포함한 IP 데이터그램이 서버 호스트에 도착
   서버는 데이터그램으로부터 TCP SYN 세그먼트 추출
   TCP 연결 승인 세그먼트 송신
3. 단계
   연결 승인 세그먼트 수신하면, 클라이언트는 연결에 버퍼와 변수 할당
   서버로 또 다른 세그먼트 송신
   위 3개의 패킷이 송신되는데 이를 '세 방향 핸드세이크'라고 부름.

## 3.6 혼잡 제어의 원리

### 3.6.1 혼잡의 원인과 비용

### 3.6.2 혼잡 제어에 대한 접근법

- 종단 간의 혼잡 제어
  네트워크 계층은 혼잡 제어 목적을 위해 트랜스포트 계층에 어떤 직접적인 지원 제공하지 않음.
  네트워크에서 혼잡의 존재는 관찰된 네트워크 동착에 기초하여 종단 시스템의 추측해야함.
  TCP 세그먼트 손실은 네트워크의 혼잡의 발생 표시로 간주해, TCP는 그에 따른 윈도 크기를 줄여야함.
- 네트워크 지원 혼잡 제어
  라우터들은 네트워크 안에서 혼잡 상태와 관련하여 송신자나 수신자 또는 모두에게 직접적인 피드백을 제공

## 3.7 TCP 혼잡 제어

### 3.7.1 전통적인 TCP 혼잡 제어

1. 손실된 세그먼트는 혼잡을 의미하며, 이에 따라 TCP 전송률은 한 세그먼트를 손실했을 때 걸어야한다.
2. 확인 응답된 세그먼트는 네트워크가 송신자의 세그먼트를 수신자에게 전송된다는 것이고, 이에 따라 이전에 확인응답 되지 않은 세거믄트에 대해 ACK가 도착하면 송신자의 전송률은 증가할 수 있다
3. 대역폭 탐색.

#### 슬로 스타트

- 네트워크가 과부하 되지 않도록 송신 속도를 천천히 증가시킴

#### 혼잡 회피

- 네트워크 과부하 방지하면서 데이터 전송 속도를 증가시킴

#### 빠른 회복

- 타임 아웃이 발생하면 슬로우 스타트 및 혼잡 회피에서와 같은 동착 수행 후, 슬로 스타트로 전이.

#### TCP 큐빅

- TCP 큐빅은 최근 널리 보급됨. 리눅스 운영체제 사용되는 TCP의 기본 버전

### 3.7.2 네트워크 지원 명시적 혼잡 알림과 지연 기반 혼잡 제어

#### 명시적 혼잡 알림

- 인터넷 내에서 수행되는 네트워크 지원 혼잡 제어의 한 형태
- 네트워크 계층에서 IP 데이터그램 헤더 서비스 유형 필드 2비트 ECN 사용됨.

* ENC 비트는 라우터가 정체를 겪오 있을 나타내기위해 라우터에서 사용됨.
* 혼잡 표시된 데이터그렘에서 목적지 호스트로 전달되어 송신 소트에게 알림.
* 손실이 발생하기 전에 혼잡 싲가을 송신자에게 알리기 위해 혼잡 알림 비트를 설정

#### 지연 기반 혼잡 제어

- 패킷 손실 이전에 더 일찍 전송 속도를 줄여 패킷 손실 및 재전송을 피함.
- 혼잡 회피 접근 반식은 지연 기반 접근 방식을 취해 패킷 손실이 발생하기 전에 혼잡 시작을 사전에 감지.

### 3.7.3 공평성

- 병목 링크 : 각 연결에 대해 연결 경로상에 있는 모든 링크는 혼잡하지 않고 병목 링크의 전송 용량과 비교해서 충분한 전송 용량을 갖음.

### 3.8 트랜스포트 계층 기능의 발전

#### QUIT : 빠른 UDP 인터넷 연결

- QUIT 주요 기능
  1.  연결지향적이고 안전함
      QUIT는 두 종단간의 연결지향 프로토콜
      연결 상태 설정을 위해 종단간의 핸드세이크 필요
  2.  스트림
      연결을 통해 여러 애플리케이션 레벨의 스트림을 다중화 할 수 있음
      연결이 설정되면 새 스트림을 빠르게 추가할 수 있음
  3.  신뢰적이고 TCP 친화적인 혼잡 제어 데이터 전송
      독립적으로 신로적인 데이터 전송을 제공.
      스트림별로 신뢰적이고 순서대로 전달되기에 손실된 UDP 세거먼트는 해당 세그먼트 데이터가 전달된 스트림에만 영향을 줌.

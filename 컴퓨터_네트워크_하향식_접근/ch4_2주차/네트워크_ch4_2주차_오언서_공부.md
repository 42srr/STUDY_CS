## 4.3 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등

### 4.3.1 IPv4 데이터그램 포맷

데이터그램: 네트워크 계층 포맷

#### IPv4 데이터그램의 주요 필드

- 버전번호
    - 4비트로 데이터그램의 IP 프로토콜 버전 명시
    - 라우터는 버전 번호를 확인하여 데이터그램의 나머지 부분을 어떻게 해석할지 결정
    - 다른 버전의 IP 는 다른 데이터그램 포맷을 사용
- 헤더길이
    - 헤더에 가변 길이의 옵션 포함하므로 이 네 비트로 IP 데이터그램에서 실제 페이롣드 가 시작하는 곳 결정
- 서비스 타입
    - 각기 다른 유형의 IP 데이터 그램 구별 → 실시간 데이터그램과 비실시간 트래픽 구분에 유용
    - 제공될 특정 서비스 레벨은 해당 라우터의 네트워크 관리자가 결정하고 구성할 정책 문제
- 데이터그램 길이
    - 바이트로 계산한 IP 데이터그램(헤더와 데이터)의 전체 길이
- 식별자, 플래그, 단편화 오프셋
    - IP 단편화와 관련있음
    - 큰 IP 데이터그램이 여러 개의 작은 IP 데이터그램으로 분할된 다음 목적지로 독립적으로 전달되며, 여기서 페이로드 데이터가 최종 호스트의 트랜스포트 계층으로 전달되기 전에 다시 모임
    - IPv6 에서는 단편화 허용 x
- TTL(time-to-live)
    - 네트워크에서 데이터그램이 무한히 순환하지 않도록 함
    - TTL 필드가 0이 되면 데이터그램 폐기
- 프로토콜
    - IP 데이터그램이에서 데이터부분이 전달될 목적지의 트랜스포트 계층의 특정 프로토콜 명시
- 헤더 체크섬
    - 라우터가 수신한 IP 데이터그램의 비트 오류 탐지하는데 도움을 줌
- 출발지와 목적지 IP 주소
- 옵션
    - 옵션 필드는 IP 헤더를 확장함
- 데이터(페이로드)
    - 전달할 데이터

### 4.3.3 IPv4 주소체계

- 32비트(4바이트)로 약 40억 개의 고유 주소 제공
- **표기 방식**: `a.b.c.d` (점으로 구분된 10진수 표기)
- 호스트 및 라우터의 인터페이스(각 인터페이스는 고유한 IP 주소 보유)에 할당
- **네트워크와 서브넷**: 여러 호스트를 포함하며, 서브넷을 통해 IP 주소를 관리
- **서브넷 마스크**: `/24` 형식으로 네트워크 주소 부분을 표시
- **CIDR(Classless Inter-Domain Routing)**
    - 서브넷을 유연하게 구분하는 방식
    - 주소의 일부를 공유하는 대규모 네트워크 지원
    - 기존 A, B, C 클래스 시스템을 대체하여 더 효율적인 IP 할당 가능

**브로드캐스트 주소**

- **기능**: 같은 서브넷 내의 모든 호스트에게 메시지를 전달

#### 주소 블럭 획득

**ISP**

- ISP는 상위 기관(ICANN)과 협력하여 IP 주소 블록을 할당받음
- 할당받은 큰 블록을 작은 블록으로 나누어 여러 조직에 재분배

**ICANN**

- 전 세계 IP 주소를 중앙에서 관리
- **RIR(지역 인터넷 등록소)에 주소 블록 할당**
- **도메인 이름 관리 및 분쟁 해결**
- **비영리 단체로 운영**

#### **호스트 주소 획득:  동적 호스트 구성 프로토콜**

**DHCP**

- DHCP는 호스트가 자동으로 IP 주소를 받게 해주는 프로토콜
- 호스트가 네트워크에 접속할 때마다 동일한 IP를 받거나, 임시 IP를 할당받을 수 있음
- 추가 정보(서브넷 마스크, 기본 게이트웨이, DNS 서버 등)도 자동으로 받음

→

- 수동 설정 없이 자동으로 네트워크에 연결 가능.
- 특히 이동하는 장비(예: 랩탑)에 유용.
- "플러그 앤 플레이" 또는 "제로 구성"

**DHCP 동작 과정**

- **1단계 (DHCP 발견)**:
    
    호스트는 DHCP 서버를 찾기 위해 브로드캐스트 메시지(DHCP discover)를 보냄
    
- **2단계 (DHCP 제공)**:
    
    DHCP 서버가 클라이언트에게 IP 주소와 네트워크 정보가 담긴 제공 메시지(DHCP offer)를 보냄
    
- **3단계 (DHCP 요청)**:
    
    클라이언트가 제공된 서버 중 하나를 선택하고, 요청 메시지(DHCP request)를 보냄
    
- **4단계 (DHCP ACK)**:
    
    서버가 클라이언트의 요청을 확인하고, DHCP ACK 메시지로 응답합니다. 이제 클라이언트는 임대된 IP 주소를 사용할 수 있음
    

**단점**

- 서브넷을 넘어가면 기존 TCP 연결이 끊길 수 있음

**#### 4.3.3 네트워크 주소 변환(NAT)**

**NAT**

- NAT는 홈 네트워크와 인터넷 사이의 IP 주소 충돌 문제를 해결
- 홈 네트워크에서 사용하는 사설 IP 주소를 외부 인터넷과 통신할 수 있는 공인 IP 주소로 변환

**사설 주소와 NAT**

- 사설 주소 범위(예: 10.0.0.0/24)는 외부 네트워크와 충돌할 수 있기 때문에 NAT를 통해 변환됩니다.

**NAT 라우터의 동작**

- NAT 라우트는 홈 네트워크에서 나가는 트래픽을 하나의 공인 IP 주소로 변환하고, 그에 대한 포트 번호를 관리
- 라우터는 각 트래픽에 대해 NAT 변환 테이블을 사용하여 어떤 내부 호스트로 데이터를 보낼지 결정
- NAT는 포트 번호를 사용해 다수의 연결을 처리하는데, 이는 호스트 주소 지정이 아니라 프로세스 주소 지정에 의존
    
    → 이는 서버가 홈 네트워크 뒤에서 제대로 동작하지 않을 수 있는 문제를 발생시킬 수 있음
    
    → NAT 순회(NAT Traversal) 기술을 통해 NAT 뒤에 있는 호스트 간의 연결 문제를 해결 가능

### 4.3.4 IPv6

- IPv6는 32비트에서 128비트 주소로 확장 → 주소 고갈 문제를 해결
- **간소화된 40바이트 헤더**
- **흐름 레이블링**
  - 특정 흐름에 대해 특별한 처리를 요청할 수 있는 기능이 도입

#### IPv6 데이터그램 포맷

- IPv6의 버전은 6
- **트래픽 클래스**: 8비트 필드로 애플리케이션에 우선순위를 부여한다.
- **흐름 레이블**: 20비트 필드로, 특정 흐름을 식별한다.
- **페이로드 길이**: 데이터그램의 크기 정보를 나타낸다.
- **다음 헤더**: 패킷 내에서 다음 처리할 프로토콜을 정의한다.
- **홉 제한**: 데이터그램을 전달할 때마다 감소하며, 0에 도달하면 패킷을 폐기한다.
- **출발지/목적지 주소**: 128비트 주소를 사용한다.

#### 변경된 점

- **단편화/재결합**: IPv6에서는 송신지와 수신지만 단편화 및 재결합을 처리한다. 라우터는 패킷을 폐기하고 ICMP 오류 메시지를 보낸다.
- **헤더 체크섬**: 체크섬 기능이 생략되어, 트랜스포트 계층과 데이터 링크 계층에서만 체크섬을 수행한다.
- **옵션**: 옵션 필드는 '다음 헤더' 필드로 이동, 필요시 TCP/UDP 프로토콜 등의 헤더로 처리된다.

#### IPv4에서 IPv6로의 전환

- **플래그 데이(Flag Day)**: 전 세계 모든 인터넷 장비를 동시에 IPv6로 전환하는 방식은 현실적으로 불가능하다.
- **터널링**: IPv4 네트워크를 통해 IPv6 데이터를 전송할 수 있도록 하는 기술로, IPv6 데이터를 IPv4 데이터그램에 담아 전송한다.
- IPv6의 채택은 서서히 진행되고 있으며, 예를 들어 구글의 서비스에 약 25%의 클라이언트가 IPv6를 사용하고 있다.
- **전환의 어려움**: 네트워크 계층 프로토콜의 변화는 매우 어려운 작업이다. 애플리케이션 계층의 새로운 프로토콜 도입은 상대적으로 빠르게 이루어질 수 있다. IPv6로의 전환은 점진적이며, 인터넷의 네트워크 계층 변화는 애플리케이션 계층보다 느리게 진행될 것이다.

---

## 4.4 일반화된 포워딩 및 소프트웨어 기반 네트워크(SDN)

### 4.4.1 일반화된 포워딩

1. **일반화된 포워딩**:
   - **매치 플러스 액션** 방식: 다양한 헤더 필드를 기준으로 패킷을 처리.
   - 예: 목적지 주소, 프로토콜, 트래픽 클래스 등을 기준으로 패킷을 출력 포트로 전달하거나, 로드 밸런싱, 패킷 삭제, 복사본 전송 등 다양한 액션 수행.

2. **OpenFlow**:
   - SDN의 핵심 기술로 **매치 플러스 액션** 포워딩을 구현.
   - **플로우 테이블**: 패킷 헤더와 매치되는 규칙을 정의하고, 매칭되는 패킷에 대해 여러 액션(출력 포트 지정, 삭제, 복사본 전송 등)을 수행.
   - **카운터**: 매칭된 패킷의 수를 추적.

3. **SDN의 장점**:
   - **중앙 집중식 제어**: 네트워크 관리자가 네트워크 동작을 소프트웨어로 제어하고 유연하게 변경 가능.
   - **네트워크 기능 프로그래밍**: 방화벽, 로드 밸런싱, 가상 네트워크 등 다양한 기능을 소프트웨어적으로 정의하고 구현할 수 있음.

---

### 4.4.2 매치

1. **OpenFlow 매치 개념**:
   - OpenFlow는 **패킷 헤더**의 다양한 필드에서 매치할 수 있음.

2. **매치 가능한 필드**:
   - **링크 계층(2계층)**: MAC 주소, 이더넷 타입, VLAN
   - **네트워크 계층(3계층)**: IP 출발지/목적지 주소, IP 프로토콜, 서비스 타입
   - **트랜스포트 계층(4계층)**: 출발지/목적지 포트 번호
   - **진입 포트**: 패킷이 수신된 포트

3. **와일드카드 사용**:
   - 일부 필드는 와일드카드를 사용하여 매치 가능.
   - 예: `128.119.*.*`는 첫 16비트가 `128.119`인 IP 주소와 매치됨.

4. **우선순위**:
   - 여러 매치 항목에 일치하는 패킷이 있을 경우, **우선순위**가 높은 항목에 해당하는 액션을 수행.

5. **매치 불가능한 필드**:
   - 일부 필드는 매치할 수 없음. 예: TTL, 데이터그램 길이.
   - 이유: **기능과 복잡성의 균형**을 맞추기 위함. 불필요한 세부 사항을 제외하고 핵심적인 기능을 제공하려는 목표.

6. **디자인 철학**:
   - OpenFlow의 설계는 **단순화**와 **효율성**을 고려해 매치 가능한 필드를 선택.
   - 버틀러 램프슨: "한 번에 한 가지 일을 잘하라."는 철학을 반영.

### 4.4.2 액션

1. **액션 목록**:
    - 각 **플로우 테이블 엔트리**는 패킷 처리 방법을 결정하는 **액션 목록**을 가짐.
    - 여러 액션이 있을 경우, **지정된 순서**대로 수행됨.
2. **주요 액션 종류**:
    - **포워딩 (Forwarding)**:
        - 패킷을 **특정 출력 포트**로 전달.
        - 패킷을 **브로드캐스트**하거나, **멀티캐스트**할 수 있음.
        - 패킷을 **원격 컨트롤러로 캡슐화**하여 전송한 뒤, 컨트롤러가 패킷을 처리하고 새로운 플로우 테이블을 갱신하여 포워딩.
    - **삭제 (Dropping)**:
        - 플로우 테이블에 매치되는 패킷을 **삭제**하는 액션.
    - **필드 수정 (Modify-field)**:
        - 패킷을 전달하기 전에 **헤더 필드**(IP 프로토콜 제외)를 수정.
        - 2, 3, 4계층의 패킷 헤더 필드를 수정할 수 있음.

### 4.4.3 매치 플러스 액션 작업의 OpenFlow 예

#### 첫 번째 예: 간단한 포워딩

- **네트워크 구성**: 6개의 호스트(h1, h2, h3, h4, h5, h6)와 3개의 패킷 스위치(s1, s2, s3).
- **포워딩 동작**: h5 또는 h6에서 패킷이 s3 → s1 → s2로 전달됨.
- **S1 플로우 테이블**:
    - **매치**: Ingress Port = 1; IP Src = 10.3.*.*; IP Dst = 10.2.*.*
    - **액션**: Forward(4) (S1에서 S2로 전달)
- **S2 플로우 테이블**:
    - **매치**: Ingress Port = 2; IP Dst = 10.2.0.3 또는 10.2.0.4
    - **액션**: Forward(3) 또는 Forward(4) (S2에서 S3 또는 S4로 전달)

#### 두 번째 예: 로드 밸런싱

- **목적**: h3의 패킷은 s2와 s1 사이로, h4의 패킷은 s2와 s3 사이로 전달되어 로드 밸런싱 수행.
- **S2 플로우 테이블**:
    - **매치**: Ingress Port = 3; IP Dst = 10.1.*.* / Ingress Port = 4; IP Dst = 10.1.*.*
    - **액션**: Forward(2) 또는 Forward(1) (s2에서 각각 s1 또는 s3로 전달)

#### 세 번째 예: 방화벽

- **목적**: s2가 s3에 연결된 호스트에서만 트래픽을 수신.
- **S2 플로우 테이블**:
    - **매치**: IP Src = 10.3.*.*
    - **액션**: Forward(52) (s2에서 10.3.*.*의 트래픽만 전달)

- **일반화된 포워딩**은 다양한 논리적 동작을 지원.
- **플로우 테이블을 활용한 가상 네트워크**를 구성할 수 있으며, 이는 물리적 네트워크 자원을 공유하면서 독립적인 포워딩 동작을 가능하게 함.
- **OpenFlow**는 제한된 형태의 프로그래밍 가능성만 제공하지만, **P4**와 같은 고급 프로그래밍 언어는 더 복잡한 데이터그램 처리를 위한 다양한 기능을 제공.

### 4.5 미들박스

- **미들박스**: 네트워크 경로에서 라우터의 기본 기능 외에 추가적인 작업을 수행하는 장비. RFC 3234에 따르면 "출발지와 목적지 사이의 데이터 경로에서 라우터의 표준 기능을 제외한 다른 기능을 수행하는 장비
- **NAT 변환**: 사설 네트워크의 주소를 공인 주소로 변환하여 패킷 헤더의 IP 주소와 포트 번호를 수정.
- **보안 서비스**:
    - **방화벽**
    - **침입 탐지 시스템(IDS)**: 미리 정의된 패턴을 탐지하여 필터링.
    - **애플리케이션 레벨 필터링**: 이메일 필터링(정크 메일, 피싱 등).
- **로드 밸런싱**: 여러 서버 중 적합한 서버로 요청을 분배하는 역할 (예: HTTP 요청 또는 검색엔진 질의 처리).
- 미들박스는 **네트워크 기능 가상화(NFV)**와 결합되어, 소프트웨어 스택 위에서 실행되는 전문화된 미들박스를 통해 운영비용 절감 및 효율성을 추구.
- **클라우드 아웃소싱**: 일부 미들박스 기능을 클라우드로 이전하여 운영 효율성 증가.

**미들박스와 전통적인 네트워크 아키텍처의 차이**

- 과거 **네트워크 계층과 트랜스포트/애플리케이션 계층**은 명확히 분리되어 있었으나, **미들박스**는 이러한 분리를 위반
- **방화벽**은 네트워크 계층, 트랜스포트 계층, 애플리케이션 계층의 정보를 모두 사용하여 패킷을 필터링

- 미들박스는 점점 더 중요해지고 있으며, 그 존재와 역할이 계속해서 확대될 것으로 예상.
- 네트워크에서 서비스 기능 배치에 대한 질문은 **엔드 투 엔드 원리**와 관련이 있음.

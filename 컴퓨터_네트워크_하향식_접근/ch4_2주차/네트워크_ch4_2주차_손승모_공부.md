# 네트워크

## 4.3 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등

### 4.3.1 IPv4 데이터그램 포맷

- 인터넷 네트워크 계층 패킷을 데이터그램이라고 부른다.
- 버전 번호
  - 4비트로 데이터그램의 IP 프로토콜 버전을 명시
- 헤더 길이
  - IP 데이터그램에서 실제 페이로드가 시작하는 곳을 결정한다.
  - 대체로 IPv4 데이터그램 헤더는 20바이트다.
- 서비스 타입
  - 각기 다른 유형의 IP 데이터그램을 구별한다.
- 데이터그램 길이
  - 바이트로 계산한 IP 데이터그램(헤더와 데이터)의 전체 길이
- 식별자, 플래그, 단편화 오프셋
  - IP 단편화와 관련
- TTL
  - TTL 필드가 0이 되면 라우터가 데이터그램을 폐기한다.
- 프로토콜
  - IP 데이터그램이 최종 목적지에 도착했을 때만 사용된다.
  - 이 필드값은 IP 데이터그램에서 데이터 부분이 전달될 목적지의 트랜스포트 계층의 특정 프로토콜을 명시
- 헤더 체크섬
  - 라우터가 수신한 IP 데이터그램의 비트 오류를 탐지하는데 도움
- 출발지와 목적지 IP 주소
  - 출발지가 데이터그램을 생성할 때, 자신의 IP 주소를 출발지 IP 주소 필드에 삽입하고 목적지 IP 주소를 목적지 IP 주소 필드에 삽입한다.
- 옵션
  - IP 헤더 확장한다.
  - 모든 데이터그램 헤더 옵션 필드에 정보를 포함하지 않는 방법으로 오버헤드를 해결하기 위해 헤더 옵션은 거의 사용되지 않는다.
- 데이터(페이로드)
  - 데이터그램이 존재하는 이유이자 가장 중요한 마지막 필드다.
- IP 데이터그램은 총 20바이트의 헤더(옵션은 없다고 가정)을 갖는다.

### 4.3.3 IPv4 주소체계

- 호스트와 물리적 링크 사이의 경계를 인터페이스라고 부른다.
- 모든 호스트와 라우터는 IP 데이터그램을 송수신할 수 있으므로 IP는 각 호스트와 라우터 인터페이스가 IP 주소를 갖도록 요구한다.
- 따라서 기술 면에서 IP 주소는 인터페이스를 포함하는 호스트 라우터보다는 인터페이스와 관련이 있다.
- IP 용어로 세 호스트들의 인터페이스들과 하나의 라우터 인터페이스로 연결된 네트워크는 서브넷(subnet)을 구성한다고 말한다.
- subnet : 어떤 IP가 할당되었을 때 라우터를 거치지 않고 도달할 수 있는 네트워크 인터페이스 카드의 집합과 동일한 prefix.
- /24 는 서브넷 마스크라고 부른다.
- 서브넷의 IP 정의는 여러 호스트를 라우터 인터페이스에 연결하는 이더넷 세그먼트만을 의미하는 것은 아니다.
- 서브넷을 결정하려면 먼저 호스트나 라우터에서 각 인터페이스를 분리하고 고립된 네트워크를 만든다.
- 이 고립된 네트워크의 종단점은 인터페이스의 끝이 된다.
- 이렇게 고립된 네트워크 각각을 서브넷이라고 부른다.
- 인터넷 주소 할당 방식에 **CIDR(Classless InterDomain Routing, 사이다(cider))**  라는 것이 있다.
- CIDR는 서브넷 주소체계 표기를 일반화하고 있다.
- 서브넷 주소체계로서, 32비트 IP 주소는 두 부분으로 나누고, 이것은 다시 점으로 된 십진수 형태의 a,b,c,d/x를 가지며, 야기서 x는 주소 첫 부분의 비트수다.
- a,b,c,d/x 형식 주소에서 최상위 비트(MSB)를 의미하는 x는 IP 주소의 네트워크 부분을 구성한다. 이를 해당 주소의 **프리픽스(prefix)** 또는 **네트워크 프리픽스** 라고 부른다.
- CIDR가 채택되기 전에는 IP 주소의 네트워크 부분을 8, 16, 24비트로 제한했고, 8, 16, 24비트 서브넷 주소를 갖는 서브넷을 각각 A, B, C 클래스 네트워크로 분류했기 때문에 이러한 주소체계는 **클래스 주소체계**라고 알려졌다.

#### 주소 블록 획득

- 기관의 서브넷에서 사용하기 위한 IP 주소 블록을 얻디 위해, 네트워크 관리자는 먼저 이미 할당받은 주소의 큰 블록에서 주소를 제공하는 ISP와 접촉해야 한다.

#### 호스트 주소 획득 : 동적 호스트 구성 프로토콜

- DHCP는 UDP 기반 동작
- 호스트에 IP 주소를 할당하는 것은 수동으로 구성이 가능하지만 일반적으로 **동적 호스트 구성 프로토콜(Dynamic Host Configuration Protocol, DHCP)** 을 더 많이 사용한다.
- DHCP는 호스트가 IP 주소를 자동으로 얻을 수 있게 한다.
- DHCP는 호스트 IP 주소의 할당뿐만 아니라, 서브넷 마스크, 첫 번째 홉 라우터(디폴트 게이트웨이) 주소나 로컬 DNS 서버 주소 같은 추가 정보를 얻게 해준다.
- **플러그 앤 플레이 프로토콜 (plug-and-play protocol)** 또는 **제로 구성 프로토콜(zero-configuration protocol)** 이라고도 한다.
- DHCP의 4단계
  - **DHCP 발견 메시지(DHCP discover msssage)**
    - Broadcast
    - Optional
  - **DHCP 제공 메시지(DHCP offer message)**
    - 수신된 발견 메시지의 트랜잭션 ID, 클라이언트에 제공된 IP 주소, 네트워크 마스크, **IP주소 임대 기간(IP address lease time, IP주소가 유효한 시간)** 을 포함한다.
    - Broadcast
    - Optional
  - **DHCP 요청 메시지(DHCP request message)**
  - **DHCP ACK 메시지(DHCP ACK message)**
- DHCP discover / DHCP offer 메시지의 경우 transaction ID 동일
- DHCP request / DHCP ACK 메시지의 경우 transaction ID 동일
- 이동 노드가 서브넷 사이를 이동할 때 원격 애플리케이션에 대한 TCP 연결을 유지될 수 없다.

### 4.3.3 네트워크 주소 변환 (NAT)

- **네트워크 주소 변환 ()Network Addresss Translation)**
- 사설 IP와 관련
- NAT 가능 라우터는 외부 세계로는 라우터처럼 보이지 않는다.
- 본질적으로 NAT 가ㅇ 라우터는 외부에서 들어오는 홈 네트워크의 상세한 사항을 숨긴다.
- 라우터는 ISP의 DHCP 서버로부터 주소를 얻고, NAT-DHCP-라우터로 제어되는 홈 네트워크의 주소 공간에서 DHCP 서버를 실행하여 컴퓨터에게 주소를 제공한다.
- **NAT 변환 테이블**을 사용해 그 테이블에 IP 주소와 포트 번호를 포함한다. 이를 통해 NAT 라우터에 모든 데이터그램이 도착하면, 라우터가 주어진 데이터그램을 전달하는 내부 호스트를 알 수 있다.

### 4.3.4 IPv6

#### IPv6 데이터그램 포맷

- IPv6의 중요한 변화
  - 확장된 주소 기능

    - IPv6는 IP주소 크기를 32비트에서 128비트로 확장했으므로 IP 주소가 고갈되는 일은 발생하지 않을 것이다.
    - IPv6는 유니캐스트, 멀티캐스트 주소뿐만 아니라 새로운 주소 형태인 **애니캐스트 주소**가 도입되었다. 애니캐스트 조소로 명시된 데이터그램은 호스트 그룹의 어떤 이에게든 전달될 수 있다.
  - 간소화된 40바이트 헤더
  - 흐름 레이블링
- IPv6 데이터 그램 포맷
  - 버전
  - 트래픽 클래스
  - 흐름 레이블
  - 페이로드 길이
  - 다음 헤더
  - 홉 제한
  - 출발지와 목적지 주소
  - 데이터
- IPv6에는 더 이상 존재하지 않는 필드
  - 단편화 / 재결합
    - IPv6에서는 단편화와 재결합을 출발지와 목적지만이 수행한다.
  - 헤더 체크섬
  - 옵션

#### IPv4에서 IPv6로의 전환

- 플래그 데이 선언 방법
  - 모든 인터넷 장비를 끄고 IPv4에서 IPv6로 업그레이드하는 시간과 날짜를 정하는 것
  - 불가능하다
- **터널링** (tunneling)

### 4.4 일반화된 포워딩 및 소프트웨어 기반 네트워크(SDN)

### 4.4.1 매치

### 4.4.2 액션

- 포워딩

  - 들어오는 패킷은 특정 실제 출력 포트로 전달도거나 모든 포트를 통해 브로드캐스트되거나 (선택한 포트를 제외하고) 선택된 포트 세트를 통해 멀티캐스트될 수 있다.
  - 패킷은 캡슐화되어 원격 컨트롤러로 전송될 수 있다. 그런 다음 컨트롤러는 새 플로우 테이블 엔트리를 설치하고 해당 패킷에 대해 조치를 취하거나(하지 않을수도 있음) 갱신된 플로우 테이블 규칙에 따라 포워딩을 위해 패킷을 장치로 반환할 수 있다.
- 삭제

  - 아무 액션이 없는 플로우 테이블 엔트리는 매치된 패킷을 삭제해야함을 나타낸다
- 필드 수정

  - 패킷이 선택된 출력 포트로 전달되기 전에 10개의 패킷 헤더필드의 값을 다시 쓸 수 있다.

### 4.4.3 매치 플러스 액션 작업의 OpenFlow 예

- 플로우테이블은 사실 제한된 형태의 **프로그래밍 가능성**이다.

## 4.5 미들박스

- 출발지 호스트와 목적지 호스트 사이의 데이터 경로에서 IP라우터의 정상적이고 표준적인 기능과는 별도로 기능을 수행하는 모든 미들박스
- 미들박스의 서비스
  - NAT 변환
    - NAT 박스는 사설 네트워크 주소체계를 구현하여 데이터그램 헤더 IP 주소 및 포트 번호를 다시 작성한다
  - 보안 서비스
    - 방화벽은 헤더 필드값을 기준으로 트래픽을 차단하거나 DPI(Deep Packet Inspection) 같은 추가 처리를 위해 패킷을 리다이렉션한다.
    - 침입 탐지 시스템(IDS)은 미리 결정된 패턴을 탐지하고 그에 따라 패킷을 필터링할 수 있다.
    - 애플리케이션 레벨 전자메일 필터는 정크, 피싱 또는 보안 위협 요인으로 간주되는 전자메일을 차단한다.
  - 성능 향상
    - 미들박스는 압축과 같은 서비스를 수행한다.
    - 즉 원하는 서비스를 제공할 수 있는 서버 집합 중 하나에 대한 서비스 요청 (예: HTTP 요청 또는 검색 엔진 질의)의 로드 밸런싱을 하는 추세다.
  - 수년 동안 인터넷 아키텍처는 네트워크 계층과 트랜스포트/애플리케이션 계층 사이에 명확한 분리가 있었다.
  - 오늘날의 미들박스는 이러한 분리를 명백히 위한한다.
  - 즉 라우터와 호스트 사이에 위치한 NAT 박스는 네트워크 계층 IP 주소와 트랜스포트 계층 포트 번호를 다시 쓴다.

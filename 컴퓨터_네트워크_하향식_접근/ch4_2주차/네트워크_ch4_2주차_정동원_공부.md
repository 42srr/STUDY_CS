# 4.3 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등

## **4.3.1 IPv4 데이터그램 포맷**

인터넷 네트워크 계층 패킷을 데이터그램(datagram)이라고 한다.

- **버전 번호**: 4비트로 IP 프로토콜 버전을 명시.
- **헤더 길이**: 옵션 포함 여부에 따라 헤더 길이가 결정되며 일반적으로 20바이트.
- **서비스 타입**: 실시간/비실시간 트래픽 구분.
- **데이터그램 길이**: 최대 65,535바이트(일반적으로 1,500바이트 이하).
- **식별자, 플래그, 단편화 오프셋**: IP 단편화와 관련이 있는 필드. 큰 IP 데이터그램이 여러 개의 작은 IP 데이터그램으로 분할된 다음 목적지로 독립적으로 전달된, 여기서 페이로드 데이터가 최종  호스트의 트랜스포트 계층으로 전달되기 전에 다시 모인다.
- **TTL(Time to Live)**: 데이터그램의 네트워크 순환 방지. 라우터가 데이터그램을 처리할 때마다 감소, 0이 될시 해당 데이터그램 폐기.
- **프로토콜**: TCP/UDP 등 트랜스포트 계층 프로토콜 명시.
- **헤더 체크섬**: 라우터에서 비트 오류 탐지 및 폐기.
- **출발지/목적지 IP 주소**: 데이터그램 송수신 IP 주소 명시.
- **옵션 및 페이로드**: 확장 가능한 옵션 필드와 실제 데이터.

## **4.3.2 IPv4 주소체계**

- **인터페이스(IP 주소)**: 호스트/라우터의 각 링크에 고유한 IP 주소 할당.
- **서브넷**: 동일 네트워크에 연결된 장치 그룹. 예) **`223.1.1.0/24`**.
- **CIDR(Classless Inter-Domain Routing)**:
    - **`a.b.c.d/x`** 형식으로 네트워크 프리픽스를 정의.
    - 효율적인 주소 관리와 라우팅 테이블 축소 가능.
- **클래스 주소체계**:
    - A, B, C 클래스 네트워크로 분류했으나 유연성 부족으로 CIDR 채택.

### **DHCP(Dynamic Host Configuration Protocol)**

- **역할**:
    - 호스트가 자동으로 IP 주소를 할당받고 추가 네트워크 설정 정보를 획득.
    - 플러그 앤 플레이 프로토콜로 사용.
- **동작 과정**:
    1. DHCP 서버 발견: 브로드캐스트 메시지로 서버 탐색.
    2. DHCP 서버 제공: 여러 서버 중 최적의 서버 선택.
    3. DHCP 요청: 클라이언트가 선택된 서버에 요청 메시지 전송.
    4. DHCP ACK: 서버가 요청 파라미터를 확인 후 응답.

# **4.3.3 네트워크 주소 변환 NAT(Network Address Translation)**

- **역할**:
    - 사설망 내부에서 글로벌 IP 주소 없이 인터넷 통신 가능.
    - 홈 네트워크 내부를 외부에서 숨김 처리.
- **NAT 변환 테이블**:
    - 내부 호스트와 외부 트래픽 간 매핑을 관리(IP 주소 + 포트 번호).

# **4.3.4 IPv6**

## **주요 변화**

1. **확장된 주소 공간**:
    - 32비트 → 128비트로 확장, 유니캐스트/멀티캐스트/애니캐스트 지원.
2. **간소화된 헤더**:
    - 고정 길이 40바이트 헤더로 라우터 처리 속도 향상.
3. **흐름 레이블링**:
    - 특정 흐름 패킷에 대한 차별화 가능.

## **IPv6 데이터그램 포맷**

- 버전, 트래픽 클래스, 흐름 레이블, 페이로드 길이, 다음 헤더, 홉 제한 등.

## **IPv4와 IPv6 차이점**

1. IPv6에서는 단편화와 재결합을 송신자와 수신자만 수행(라우터는 폐기).
2. 헤더 체크섬 및 옵션 필드 제거로 처리 속도 향상.

## **IPv6 전환 방식**

1. 플래그 데이 선언은 현실적으로 불가능.
2. 터널링 방식 사용:
    - IPv6 데이터그램을 IPv4 데이터그램에 캡슐화하여 전달.

# **4.4 일반화된 포워딩 및 소프트웨어 기반 네트워크(SDN)**

## **일반화된 포워딩**

- 기존의 목적지 기반 포워딩은 패킷의 목적지 IP 주소를 기준으로 출력 포트를 결정.
- **일반화된 매치 플러스 액션** 방식은 프로토콜 스택의 다양한 계층의 헤더 필드(예: IP, TCP/UDP 등)를 매치하여 다양한 작업(Action)을 수행:
    - **액션 종류**:
        - 특정 출력 포트로 패킷 전달.
        - 로드 밸런싱 수행.
        - 헤더 값 수정.
        - 패킷 삭제 또는 차단.
        - 특정 서버로 패킷 전달(추가 처리용).
- 각 패킷 스위치는 원격 컨트롤러에 의해 계산된 **매치 플러스 액션 테이블**을 사용.

## **OpenFlow 1.0**

- OpenFlow는 SDN의 핵심 프로토콜로, 매치 플러스 액션 기반의 포워딩 테이블을 정의.
- **플로우 테이블 엔트리 구성**:
    1. **매치 필드**: 패킷 헤더 값(예: IP 주소, TCP/UDP 포트 등)과 입력 포트를 기준으로 매치 수행.
        - 와일드카드 매치 가능(예: **`128.119.*.*`**).
        - 일부 필드(TTL, 데이터그램 길이)는 매치 불가.
    2. **액션**: 매치된 패킷에 대해 수행할 작업 정의.
        - 출력 포트로 전달, 삭제, 복사본 생성, 헤더 필드 수정 등.
    3. **카운터**: 매치된 패킷 수와 바이트 수를 기록.

## **매치와 액션**

## **매치**

- OpenFlow 1.0은 11개의 주요 헤더 필드(IP, TCP/UDP 등)와 입력 포트를 매칭 기준으로 사용.
- 플로우 테이블 엔트리는 우선순위를 가지며, 여러 엔트리와 매치될 경우 가장 높은 우선순위가 적용.

## **액션**

- 플로우 테이블 엔트리는 0개 이상의 액션 리스트를 포함하며, 순차적으로 실행:
    - **포워딩**:
        - 특정 출력 포트로 전달하거나 브로드캐스트/멀티캐스트 수행.
        - 원격 컨트롤러로 캡슐화하여 전송 가능.
    - **삭제**: 매치된 패킷을 즉시 폐기.
    - **필드 수정**: 헤더 필드를 변경(NAT처럼 IP 주소/포트 변경 가능).

## **OpenFlow 예시**

1. **간단한 포워딩**:
    - 호스트 h5/h6에서 h3/h4로 가는 데이터그램을 s1과 s2를 통해 전달.
    - 각 스위치는 해당 경로에 맞는 플로우 테이블 엔트리를 설정.
2. **로드 밸런싱**:
    - h3에서 특정 목적지(**`10.1.*.*`**)로 가는 데이터그램은 s2 → s1 경로를 사용.
    - h4에서 동일 목적지로 가는 데이터그램은 s2 → s3 경로를 사용.
3. **방화벽**:
    - s2는 특정 서브넷(**`10.3.*.*`**)에서 오는 트래픽만 허용하도록 설정.

## **SDN과 일반화된 포워딩의 특징**

- SDN은 전통적인 네트워크와 달리 제어 평면(Control Plane)과 데이터 평면(Data Plane)을 분리:
    - 원격 컨트롤러가 네트워크 상태 정보를 수집하고 플로우 테이블을 계산하여 각 스위치에 배포.
- 일반화된 포워딩은 단순히 목적지 주소뿐 아니라 다양한 헤더 필드를 고려하여 유연한 네트워크 동작 가능:
    - 방화벽 정책, 로드 밸런싱, QoS 관리 등을 손쉽게 구현.

# **4.5 미들박스**

미들 박스의 정의

> 출발지 호스트와 목적지 호스트 사이의 데이터 경로에서 IP 라우터의 정상적이고 표준적인 기능과는 별도로 기능을 수행하는 모든 미들박스
> 

미들 박스가 수행하는 세 가지 유형의 서비스를 광범위하게 식별할 수 있다.

- NAT 변환 : NAT 박스는 사설 네트워크 주소체계를 구현하여 데이터그램 헤더 IP 주소 및 포트 번호를 다시 작성한다.
- 보안 서비스 : 방화벽은 헤더 필드 값을 기준으로 트래픽을 차단하거나 DPI(Deep Packet Inspection) 같은 추가 처리를 위해 패킷을 리다이렉션한다. 침입 탐지 시스템(IDS)은 미리 결정된 패턴을 탐지하고 그에 따라 패킷을 필터링할 수 있다.
- 성능 향상 : 미들박스는 압축과 같은 서비스를 수행한다. 즉, 원하는 서비스를 제공할 수 있는 서버 집합 중 하나에 대한 서비스 요청의 로드 밸런싱을 하는 주체다.

미들 박스는 네트워크 계층과 트랜스포트계층, 애플리케이션 계층을 명확히 구분하는 이전 네트워크의 분리를 명백히 위반한다.

예를 들어, 라우터와 호스트 사이에 위치한 NAT 박스는 네트워크 계층 IP 주소와 트랜스포트 계층 포트 번호를 다시 쓴다.

네트워크 내의 방화벽 블록은 IP 데이터그램 헤더 뿐만 아니라 애플리케이션 계층, 트랜스포트 계층 헤더까지 사용하여 데이터그램을 의심한다.

미들박스를 아키텍처적으로 혐오스럽다고 간주하는 사람들도 있지만, 다른 이들은 이러한 미들 박스가 '중요하고 영구적으로 존재한다'는 철학을 채택하고 있다.

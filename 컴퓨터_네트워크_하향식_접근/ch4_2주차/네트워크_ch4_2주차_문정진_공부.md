# 4.3 인터넷 프로토콜(IP) : IPv4, 주소체계, IPv6

## 4.3.1 IPv4 데이터그램 포맷

- 데이터 그램 : 인터넷 네트워크 계층 패킷

<img src="4_17.png" width="500">

- 버전 번호
  - 4비트 -> 데이터그램의 IP 프로토콜 버전 명시
  - 라우터는 버전 번호 확인하여, 데이터그램의 나머지 부분 해석을 결정
  - 다른 버전의 IP는 다른 데이터그램 포맷 사용.
- 헤더 길이
  - IPv4 데이터그램은 헤더에 가변 길이 옵션 포함
  - 네 비트로 IP 데이터그램에서 실제 페이로드가 시작하는 곳 결정.
  - 대부분의 IPv4 데이터그램은 옵션을 포함하지 않아 대체로 IPv4 데이터그램 헤더는 20바이트
- 서비스 타입
  - IPv4 서비스 타입 비트는 각기 다른 유형의 IP 데이터그램을 구분.
- 데이터그램 길이
  - 바이트로 계산한 IP 데이터그램의 전체 길이.
  - 해당 빌드는 16비트, 이론상 최대 길이는 65,535 바이트
  - 하지만 1,500 바이트보다 큰 경우는 없어 최대 크기의 이더넷 프레임의 페이로드 필드에 IP 데이터그램이 장착될 수 있음.

* 식별자, 플래그, 단편화 오프셋
  - IP 단편화와 관련 있음.
  - 큰 IP 데이터그램이 여러 개의 작은 IP 데이터그램으로 분할된 다음 목적지로 독립적으로 전달.
  - 페이로드 데이터가 최종 호스트의 트랜스포트 계층으로 전달되기 전에 다시 모인다.
  - IPv6는 단편화를 허용하지 않음.
* TTL(time-to-live)
  - 네트워크에서 데이터그램이 무한히 순환하지 않도록 함.
  - 라우터가 데이더그램을 처리할 때마다 감소함.
  - TTL 필드가 0이 되면 라우터가 데이터그램을 폐기
* 프로토콜
  - IP 데이터그램이 최종 목적지에 도착했을 때 사용.
  - IP 데이터그에서 데이터 부분이 전달될 목적지의 트랜스포트 계층의 특정 프로코돌을 명시
* 헤더 체크섬
  - 라우터가 수신한 IP 데이터그램의 비트 오류 탐지에 도움을 줌
  - 헤더에서 각 2바이트를 수로 처리하고 이 1의 보수를 합산하여 계산.
  - 합의 1의 보수는 체크섬 필드에 저장.
  - 해당 값과 데이터그램 헤더의 체크섬이 다르면 오류 상태를 감지 -> 라우터는 보통 오류 검출시 데이터그램 폐기
  * TTL 필드와 옵션 필드의 값은 변경되므로 체크섬은 각 라우터에서 재계산되고 저장되어야함.
* 출발지와 목적지 IP 주소
  - 출발지가 데이터그램을 생성할 때, 자신의 IP 주소를 출발지 IP주소 필드에 삽입하고, 목적지 IP 주소를 목적지 IP 주소 필드에 삽입.
  * DNS 검색을 통해 목적지 주소를 결정.
* 옵션
  - IP 헤더를 확장.
  - 모든 데이터그램 헤더 옵션 필드에 정보를 포함하지 않는 방법으로 오버헤드를 해결하기 위해 헤더 옵션은 사용되지 않는다.
* 데이터(페이로드)
  - 데이터그램이 존재하는 이유이자 가장 중요한 마지막 필드.
  - IP 데이터그램의 데이터필드는 목적지에 전달하기 위해 트랜스포트 계층 세그먼트를 포함하지만, ICMP 메시지 같은 유형의 데이터도 담는다.

## 4.3.2 IPv4 주소체계

- 인터페이스(interface) : 호스트와 물리적 링크 사이의 경계

* IP 주소는 인터페이스를 포함하는 호스트 라우터보다는 인터페이스와 관련이 있다.

* IP 주소는 32비트 길이(4바이트)
* 전 세계 인터넷의 모든 호스트와 라우터는 각 인터페이스는 고유한 IP주소를 얻는다.
* 인터페이스의 IP 주소 일부는 연결된 '서브넷'이 결정

<img src="4_18.png" width="500">

- 서브넷 : 여러 호스트들의 인터페이스들과 하나의 라우터 인터페이스로 연결된 네트워크
- 서브넷 마스크 : IP 주소체계는 서브넷 (223.1.1.0/24)는 세 호스트 인터페이스(223.1.1.1, 223.1.1.3, 223.1.1.3)와 하나의 라우터 인터페이스(223.1.1.4) 구성.

* 네트워크 223.1.1.0/24에 새로 부착할 호스트에는 223.1.1.xxx형식의 주소가 필요.

* 서브넷의 IP 정의는 여러 호스트들를 라우터 인터페이스에 연결하는 이더넷 세그먼트만 의미하는 것은 아님.
* 서브넷을 결정하려면 먼저 호스트나 라우터에서 각 인터페이스를 분리하고 고립된 네트워크를 만듦.
* 고림된 네트워크의 종단점은 인터페이스의 끝이 됨.
* 고립된 네트워크 각각을 **서브넷**이라고 부름.

#### CIRD

    인터넷 주소 할당 방식에 CIDR(classless interdomain routing)이 있음

    CIDR 서브넷 주소체계 표기를 일반화함.

    서브넷 주소체계로, 32비트 IP주소는 두 부분으로 나뉨

    다시 점으로 된 십진수 형태의 a.b.c.d/x 를 가짐.

    x는 첫 부분의 비트 수

    해당 형식에서 최상위 비트를 의미하는 x는 IP 주소의 네트워크 부분을 구성

    해당 주소의 "프리픽스" 또는 "네트워크 프리픽스"라 부름

    외부 기관의 라우터는 목적지 주소가 내부 기관인 데이터그램을 전달할 때, 단지 앞 x비트만을 고려.

    주소 나머지 32 - x 비트들은 기관 내부에 같은 네트워크 프리픽스 갖는 모든 장비를 구별.

#### 주소 블록 획득

- 기관의 서브넷에서 사용하기 위한 IP 주소 블록을 얻기 위헤, 네트워크 관리자는 먼저 할당 받은 주소의 큰 블록에서 주소를 제공하는 ISP와 접촉해야함.

#### 호스트 주소 획득 : 동적 호스트 구성 프로토콜

- 한 기관은 ISP로부터 주소 블록 획특하여, 개별 IP 주소를 기관 내부의 호스트와 라우터 인터페이스에 할당.
- 라우터 인터페이스 주소에 대해, 시스템 관리자는 라우터 안에 IP 주소를 할당함.
- 호스트 IP 주소 할당하는 것은 수동 구성으로 가능하지만 일반적으로 **동적 호스트 구성 프로토콜** 을 사용

##### DHCP

    * DHCP는 호스트가 IP 주소를 자동으로 얻을 수 있게함.
    * 네트워크 관리자는 해당 호스트가 네트워크에 접속하고자 할 때마다 동일한 IP주소를 받거나, 다른 임시 IP 주소를 할당하도록 설정.
    * 호스트 IP 주소 할당뿐만 아니라, 서브넷 마스크, 첫 번째 홉 라우터 주소나 로컬 DNS 서버 주소 같은 추가 정보를 얻게해줌

#### DHCP 프코토콜의 수행 4단계 과정

    1. DHCP 서버 발견
    	1) 새롭게 도착한 호스트는 상호작용할 DHCP 발견.
    	2) DHCP 발견 메시지 사용하여 수행
    	3) 클라이언트는 포트 67번으로 UDP 패킷 보냄.
    	4) UDP 패킷은 IP 데이터그램으로 캡슐화
    	5) 호스트는 IP주소, DHCP주소 알지 못함.
    	6) 브로드캐스트 IP 주소 255.255.255.255
    	7) 출발 IP 주소 0.0.0.0 으로 설정
    2. DHCP 서버 제공
    	1) DHCP 발견 메시지 받은 서버
    	2) DHCP 제공 메시지를 클라이언트로 응답.
    	3) 브로드캐스트 IP 주소 255.255.255.255
    	4) 모든 노드로 브로트캐스트함.
    	5) 서브넷에는 여러 DHCP 서버 존재, 여러 제공 메시지로부터 가장 최적 위치인 DHCP서버를 선택.
    	6) 수신된 발견 메시시지의 트랜잭션 ID, 클라이언트가 제공한 IP, 네트워크 마스크, IP 주소 임대 기간을 포함.
    3. DHCP 요청
    	1) 새롭개 도착한 클라이언트, 그 이상의 서버 제공자 중에서 선택
    	2) 선택된 제공자에게 파라미터 설정으로 되돌아오는 DHCP 요청 메시지로 응답
    4. DHCP ACK
    	1) DHCP 요청 메시지에 대한 요청된 파라미터를 확인하는 DHCP ACK 메시지 응답.

## 4.3.3 네트워크 주소 변환(NAT)

- 모든 IP 활용 장체는 IP 주소가 필요.
- SOHO 네트워크의 확산으로 인해, SOHO가 장치를 연결하기 위해 LAN을 설치할 때마다 ISP는 모든 SOHO의 IP 장치를 수용할 수 있는 주소 범위를 할당해야함.
- 네트워크 주소 변환(NAT) : SOHO 네트워크의 해당 주소 범위에 인접한 부분을 해당 방식으로 주소를 할당 할 수 있음.

* 사설 주소를 갖는 권역이란 네트워크 주소들이 그 네트워크의 내부에 있는 장비에게만 의미가 있고 그런 네트워크를 의미.

* NAT 가능 라우터는 외부 세계로부터는 라우터처럼 보이지 않음
* NAT 라우터는 외부 세계로부터 하나의 IP주소를 갖는 하나의 장비로 동작.
* NAT 가능 라우터는 외부에서 들어오는 홈 네트워크의 상세한 사항을 숨김.
* 라우터는 ISP의 DHCP 서버로부터 주소를 얻고, NAT*DHCP*라우터로 제어되는 홈 네트워크의 주소 공간에서 DHCP 서버를 샐항해 컴퓨터에게 주소를 제공.
* NAT 변환 테이블을 사용해, 테으빌에 IP주소와 포트 번호를 포함함.

## 4.3.4 IPv6

- IPv4 주소 공간이 빠른 속도로 고갈되어 IP 주소 공간의 필요에 따라 IPv6 개발됨.

### IPv6 데이터그램 포맷

- 확장된 주소 기능
  - IPv6 IP주소 키그는 32비트에서 128 비트로 확장됨
  - IPv6는 유니캐스트, 멀티캐스트, 애니캐스트 주소가 도입.
- 간소화된 40바이트 헤더
  - IPv4 많은 필드가 생략되거나 옵션으로 남겨짐.
  - 40바이트 고정 길이 헤드는 라우터가 IP 데이터그램을 더 빨리 처리하게 해줌
- 흐름 레이블링
  - IPv6 정의하기 어려움 흐름을 갖고 있음.
- 버전
  - 4비트 필드는 IP 버전 번호 인식
  - IPv6 필드값은 6
- 트래픽 클래스
  - IPv4의 TOS 필드와 비슷한 의미로 만든 8비트 필드
  - SMTP 보다는 VoIP 같은 특정 애플리케이션 데이터그램에 우선순위 부여
- 흐름 테이블
  - 20비트 필드는 데이터 흐름을 인식하는데 사용
- 페이로드 길이
  - 고정 길이 40바이트 패킷 헤더 뒤에 나오는 바이트 길이며, 부호없는 정수
- 다음 헤더
  - IPv4 헤더에 있는 프로토콜 필드와 같음
- 홉 제한
  - 라우터가 데이터그램을 전달할때마다 1씩 감소
  - 제한 수가 0보다 작어지면 라우터는 데이터그램을 버려야함
- 출발지와 목적지
- 데이터
  - 데이터그램의 페이로드 부분

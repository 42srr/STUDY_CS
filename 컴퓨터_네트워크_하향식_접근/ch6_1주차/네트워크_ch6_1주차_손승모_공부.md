# 6. 링크 계층과 근거리 네트워크

- 링크 계층 채널은 근본적으로 다른 두 종류가 있다.
  - 브로드캐스트 채널로, 무선 랜, 위성 네트워크 HFC 접속 네트워크에서 다수의 호스트를 연결해준다. 브로드캐스트 통신 채널에 다수의 호스트가 연결되기 때문에 프레임 전송을 조정하기 위해 매체 접속 프로토콜이 있어야 한다.
  - 링크 계층 채널은 점대점 통신 링크이며, 이것은 원거리 링크에 의해 연결된 두 라우터 또는 사용자의 사무실 컴퓨터와 이 컴퓨터에 연결된 근처 이더넷 스위치 사이에서 사용될 수 있다.

## 6.1 링크 계층 소개

- 링크 계층 프로토콜을 실행하는 장치를 **노드** 라고 한다.
- 통신 경로상의 인접한 노드들을 연결하는 통신 채널은 **링크**라고 한다.
- 데이터그램을 출발지 호스트에서 목적지 호스트로 이동시키기 위해서는 데이터그램을 종단 간 경로의 개별 링크들로 이동시야만 한다.
- 한 링크에서 전송 노드는 데이터그램을 **링크 계층 프레임**으로 캡슐화해서 링크로 전송한다.

### 6.1.1 링크 계층이 제공하는 서비스

- 프레임화
  - 프레임은 네트워크 계층 데이터그램이 들어 있는 데이터 필드와 여러 개의 헤더 필드로 구성된다.
  - 프레임 구조는 링크 계층 프로토콜에 의해 명시된다.
- 링크 접속
  - 매체 접속 제어(Medium Access Control, MAC) 프로토콜은 링크상으로 프레임을 전송하는 규칙을 명시한다.
  - 링크의 한쪽 끝에 단일 송신자와 다른 쪽 끝에 단일 수신자가 있는 점대점 링크의 경우 MAC 프로토콜은 단순하며(또는 없다), 이 경우 송신자는 링크가 사용되지 않을 때마다 프레임을 전송할 수 있다.
  - 하나의 브로드캐스트 링크를 여러 노드가 공유하는 경우(다중 접속 문제), MAC 프로토콜은 여러 노드로부터 프레임 전송을 조정한다.
- 신뢰적 전달
  - 링크 계층의 신뢰적 전달 서비스도 확인응답과 재전송을 통해 가능해진다.
  - 링크 계층의 신뢰적 전달 서비스는 무선 링크처럼 오류율이 높은 링크에서 주로 사용되며, 트랜스포트 계층 프로토콜이나 애플리케이션 계층 프로토콜이 데이터를 종단 간에 재전송하는 방식을 취하는 것과는 달리 링크 계층 프로토콜은 오류가 발생한 링크에서 오류를 정정한다.
  - 링크 계층의 신뢰적 전달은 낮은 비트 오류율을 가진 링크에서는 불필요한 오버헤드가 될 수 있다.
  - 이런 이유로 대다수 유선 링크 계층 프로토콜은 신뢰적 전달 서비스를 제공하지 않는다.
- 오류 검출과 정정
  - 수신 노드와 링크 계층 하드웨어는 1로 전송된 프레임 비트를 0으로 또는 그 반대로 오인할 수 있다.
  - 오류가 있는 데이터그램은 전달할 필요가 없으며, 따라서 대부분의 링크 계층 프로토콜은 오류를 검출하는 방법을 제ㅇ한다.
  - 오류 검출은 송신 노드에서 프레임에 오류 검출 비트를 설정하게 하고 수신 노드에서 오류 검사를 수행하게 함으로써 가능해진다.
  - 링크 계층에서의 오류 검출은 일반적으로 더 복잡하며, 하드웨어로 구현된다.
  - 오류 정정은 프레임 안의 오류 검출뿐만 아니라 프레임의 어느 곳에서 오류가 발ㅇ했는지 정확하게 찾아낼 수 있다(오류를 정정한다)는 점을 제외하면 오류 검출과 비슷하다.

### 6.1.2 링크 계층이 구현되는 위치

- 대부분의 링크 계층은 **네트워크 인터페이스 컨트롤러 (Network Interface Controller, NIC)** 로 알려진 **네트워크 어댑터(network adapter)** 에 구현된다.
- 네트워크 어댑터의 중심에는 링크 계층 컨트롤러가 있으며, 링크 계층 컨트롤러는 앞 절에서 설명한 링크 계층 서비스의 대다수가 구현되어 있는 단일의 특수 용도 칩이다.
- 따라서 링크 계층 컨트롤러의 기능 대부분은 하드웨어로 구현된다.
- 링크 계층은 하드웨어와 소프트웨어의 조합이며, 프로토콜 스택상에서 소프트웨어와 하드웨어가 만나는 부분이라고 할 수 있다.

## 6.2 오류 검출 및 정정 기술

- 한 노드에서 물리적으로 연결된 이웃 노드로 전송한 링크 계층 프레임 안의 비트 오류 검출과 정정, 즉 **비트 레벨 오류 검출 및 정정(bit-level error detection and correction).**
- 비트 오류를 방지하기 위해 송신 노드에서 데이터 D에 오류 검출 및 정정 비트들(EDC)를 첨가한다.
- D와 EDC는 링크 레벨 프레임에 포함되어 수신 노드로 전송되며, 수신 노드에서는 비트열 D^ 과 EDC^ D^과 EDC^은 전송 도중에 비트가 변경될 수 있으므로 원래의 D나 EDC와 다를 수 있다.
- 수신자는 자신이 수신한 D^와 EDC^만으로 원래의 D가 D^과 동일한지 결정한다.
- 수신자는 오류 검출 및 정정 기술을 사용해서 항상은 아니지만 거의 모든 비트 오류를 검출할 수 있다.
- 오류 검출 비트를 사용하더라도 여전히 미검출된 비트 오류가 있을 수 있다.
- 결과적으로 수신자는 잘못된 데이터그램을 네트워크 계층으로 전달할 수 있으며, 프레임 헤더의 다른 필드의 내용이 잘못된 것을 감지 못할 수도 있다.
- 전송되는 데이터의 오류를 검출하기 위한 세가지 기술
  - 페리티 검사(오류 검출 및 정정의 기본 개념을 보기 위함)
  - 체크섬(대체로 트랜스포트 계층에서 사용)
  - 순환 정복 검사(대체로 어댑터의 링크 계층에서 사용)

### 6.2.1 패리티 검사

- 가장 단순한 형태의 오류 검출
- 짝수 패리티 기법은 사용자가 단순히 한 비를 추가하고 그 비트값을 d + 1개의 비트들(원래 정보에 패티리 비트가 하나 더해진 것)에서 1의 총 개수가 짝수가 되도록 선택한다.
- 홀수 패티 기법은 패리티 비트값을 1이 홀수개가 되도록 선택한다.
- **2차원 패리티** 기법에서는 반전된 비트를 포함하는 열과 행에 대한 패리티에 오류가 생긴다.
- 따라서 수신자는 단일 비트 오류의 발생을 검출할 수 있을 뿐만 아니라, 패리티 오류가 있는 열과 행의 인덱스값을 사용해 잘못된 비트를 실제로 식별해서 오류를 정정할 수도 있다.
- 오류를 검출 및 정정하는 수신자의 능력을 **순방향 오류 정정** 이라고 한다

### 6.2.2 체크섬 방법

- 체크섬 방법은 상대적으로 패킷 오버헤드가 적다.

### 6.2.3 순환 중복 검사(CRC)

- **(Cyclic Redundancy Check) 코드**
- CRC 코드는 **다항식 코드**로도 알려졌는데, 그 이유는 전송되는 비트열에 있는 0과 1 값을 계수로 갖는 다항식처럼 비트열을 생각할 수 있고, 또한 비트열에 적용되는 연산을 다항식 연산으로 이해하는 것이 가능하기 때문이다.
- 송신 측에서는 전송할 데이터를 특정 생성 다항식으로 나누어 나머지를 계산한다.
- 이 나머지를 원래 데이터에 추가하여 전송한다.
- 수신 측에서는 동일한 생성 다항식으로 받은 데이터를 나누어 나머지가 0이면 오류가 없다고 판한단다.
- CRC는 버스트 오류(연속된 비트 오류)를 효과적으로 검출할 수 있다.
- CRC는 오류 검출은 가능하지만 오류 정정 기능은 없어, 오류가 감지되면 일반적으로 해당 프레임을 버리고 재전송을 요청하는 방식으로 처리한다.

## 6.3 다중 접속 링크와 프로토콜

- **점대점 링크(point-to-point link)** 는 링크의 한쪽 끝에 한 송신자와 링크의 다른 쪽 끝에 한 수신자가 있다.
- 대다수의 링크 계층 프로토콜들은 점대점 링크용으로 설계되었으며, PPP(Point-to-Point Protocol)와 **HLDC(High-Level Data link Control)** 가 이에 속한다.
- 두번째 종류의 링크인 **브로드캐스트 링크(broadcast link)** 는 동일한 하나의 공유된 브로드캐스트 채널에 다수의 송신 노드 및 수신 노드가 연결된다.
- **다중 접속 문제(multiple access problem)** 은 다수의 송수신 노들의 공유되는 브로드캐스트 채널로의 접속을 조정하는 문제이다.
- 컴퓨터 네트워크에서도 공유되는 브로드캐스트 채널로 보내는 노들의 전송을 조정하기 위한 **다중 접속 프로토콜(multiple access protocol)** 이라는 프로토콜이 있다.
- 다중 접속 프로토콜은 **채널 분할 프로토콜(channel partitioning protocol), 랜덤 접속 프로토콜(random access protocol), 순번 프로토콜(taking-turns protocol)** 세가지로 분류할 수 있다.

### 6.3.1 채널 분할 프로토콜

- **TDM(시분할 다중화, time-division multiplexing)** 은 시간을 **시간 프레임(time frame)** 으로 나누고 또한 각 시간 프레임을 N개의 **시간 슬롯(time slot)** 으로 나눈다.
- 노드는 전송할 패킷이 있을 때다 TDM프레임에서 자신에게 할당된 시간 슬롯동안 패킷 비트들을 전송한다.
- 일반적으로 슬롯 크기는 한 패킷이 한 슬롯 시간 동안 전송될 수 있게 선택된다.
- TDM은 충돌을 제거할 수 있고 아주 공정하므로 바람직하다.
- 그러나 이 방식은 두 가지 단점이 있다.
  - 전송할 패킷이 있는 노드가 단 하나의 경우에도 노드 전송률이 평균 R/N으로 제ㄴ된다.
  - 노드가 전송 순서상 자신의 차례를 항상 기다려야 한다.
- **FDM(주파수 분할 다중화, Frequency-division multiplexing)** 은 하나의 큰 Rbps 채널로부터 N개의 R/N bps의 작은 채널을 만든다.
- FDM은 TDM과 같은 장단점이 있다.
- FDM은 충돌을 피하고 N개 노드에게 대역폭을 균등하게 분할한다.
- 그러나 FDM은 TDM과 같이 전송할 패킷을 가진 노드가 단 하나일지라도 노드는 R/N 대역폭으로 한정되는 단점이 있다.
- **CDMA(코드 분할 다중 접속, code division multiple access)** 는 기존 TDM과 FDM이 각각 시간 슬롯과 주파수를 노드에게 할당하지만, CDMA는 다른 코드를 각 노드에게 할당한다.
- 노드는 전송하는 데이터 비트들을 자신의 유일한 코드를 각 노드에게 할당한다.
- 그러면 노드는 전송하는 데이터 비트들을 자신의 유일한 코드로 인코딩한다.
- CDMA 네트워크에서 코드들을 신중하게 선택하면 여러 노드들이 동시에 전송할 수 있고, 다른 노드들에 의해 전송이 간섭되더다도 각 수신자들이 송신자의 인코딩된 데이터 비트를 정확하게 수신할 수 있는 훌륭한 특성이 있다.
- CDMA 코드가 다중 접속 채널 사용자에게 할당 될 수 있다

### 6.3.2 랜덤 접속 프로토콜

- 랜덤 접속 프로토콜에서 전송 노드는 항상 채널의 최대 전송률인 Rbps로 전송한다.
- 충돌이 생기면 충돌과 관련된 각 노드는 프레임(패킷)이 충돌 없이 전송될 때까지 자신의 프레임을 계속해서 재전송한다.
- 그러나 충돌했을 때 노드는 해당 프레임을 즉시 재전송할 필요가 없다
- 대신 그 프레임을 재전송하기 전에 랜덤 지연 시간 동안 기다린다.
- 이더넷은 많이 사용되고 있는 CSMA 프로토콜이다.

#### 슬롯 알로하

- 슬롯 알로하의 동작
  - 노드를 전송할 새 프레임이 있으면 다음 슬롯이 시작할 때까지 기다렸다가 그 슬롯에 전체 프레임을 전송한다.
  - 만약 충돌하지 않으면 노드는 성공적으로 자신의 프레임을 전송한 것이다. 따라서 그 프레임을 재전송할 필요가 없다. (전송할 것이 또 있으면 노드는 새 프레임을 준비한다.)
  - 만약 충돌하면, 노드는 그 슬롯이 끝나기 전에 충돌을 검출한다. 노드는 그 프레임이 충돌 없이 전송될 때까지 확률 p로 해당 프레임을 다음 슬롯들에서 재전송한다.
- 슬롯 알로하의 장점
  - 채널 분할과 달리, 슬롯 알로하는 하나의 활성 노드로 하여금 채널의 천속력 R로 계속해서 프레ㅁ을 전송할 수 있도록 허용한다.
  - 각 노드가 충돌을 감지하고 언제 재전송할지 각각 결정하므로 상당히 분산되어 있다.
- 슬롯 알로하 고려해야 할 점
  - 활성 노드가 많이 있으면 일부 슬롯이 충돌로 인해 결과적으로 낭비 된다는 것이다.
  - 모든 활성 노드 확률적인 전송 정책 때문에 전송을 억제하는 경우 일부 슬롯이 빈다는 것이다.

#### 알로하

- 슬롯 알로하 프로토콜은 모든 노드가 슬롯의 시작점에서 전송을 시작할 수 있도록 동기화되어 있기ㄹ 요구한다.
- 처음에 알로하 프로토콜은 슬롯이 없고 완전히 분산된 프로토콜이었다.
- 순수 알로하로 알려진 이 프로토콜에서는 프레임이 도착하면 노드는 즉시 그 프레임 전체를 브로드캐스트 채널로 전송한다.
- 만일 전송된 프레임이 하나 이상의 다른 전송과 충돌하면 노드는 확률 p로 그 프레임을 즉시 재전송하다.
- 즉시 재전송하지 않는 경우 노드는 프레임 전송시간 동안 기다린다.

#### CSMA

- 말하기 전에 듣는다.
  - 네트워크는 이것을 **캐리어 감지(carrier sensing)** 라고 한다.
  - 만일 다른 노드가 프레임 채널로 전송하고 있을 경우, 노드는 임의의 짧은 시간 동안 전송 중단을 감지하면 프레임을 전송하기 시작한다.
- 다른 사람이 동시에 말하기 시작하면 말을 중단한다.
  - 네트워크에서 이것을 **충돌 검출(collision detection)** 라고 한다.
  - 만일 다른 노드가 방해 프레임을 전송하고 있음을 검출하면, 자신의 전송을 중단하고 랜덤 시간 동안 기다린 후 유휴 시 감지 및 전송과정을 반복한다.
- 이 두 규칙은 **CSMA(carrier sense multiple access)** 와 **CSMA/CD(CSMA with collision detection)** 프로토콜에 포함된다.
- CSMA에 대해 물어볼 수 있는 질문은 "만일 모든 노드가 매체 감지를 하면 어떻게 충돌이 발생할 수 있는가?"이다
  - 이 경우에 노드는 다른 노드가 전송하고 있음을 감지할 때마다 자신의 전송을 억제한다.
- 브로드캐스트 채널 종단 간의 **채널 전파 지연(channel propagation delay, 신호가 채널의 한쪽 끝에서 다른 쪽 끝으로 전파되는 데 걸리는 시간)** 이 CSMA의 성능을 결정하는데 중요한 역할

#### CSMA/CD

- 다중 접속 프로토콜에 충돌 검출을 추가하면, 쓸모없는 손상된 프레임(다른 노드로부터의 프레임으로 인한 간섭 때문에 생긴 것)을 모두 전송하지 않아도 되므로 프로토콜의 성능을 확실히 향상할 수 있다.
- 브로드캐스트 채널에 접속된 (노드의) 어댑터에서 CSMA/CD 프로토콜은 다음과 같이 동작한다.
  - 어댑터는 네트워크 계층으로부터 데터그램을 받아서 링크 계층 프레임을 만든 후에 그 프레임을 어댑터의 버퍼에 저장한다.
  - 어댑터는 채널이 유휴(idle) 상태임을 감지하면(즉 채널로부터 어댑터로 들어오는 신호 에너가 없으면) 프레임 전송을 시작한다. 만일 어댑터가 채털이 바쁜(busy) 상태임을 감지하면, 어떤 신호 에너지도 감지되지 않을 때까지 더 기다렸다가 프레임을 전송하기 시작한다.
  - 전송하는 동안 어댑터는 브로드캐스트 채널을 사용하는 다른 어댑터로부터의 신호 에너지가 있는지 검사한다.
  - 프레임 전체를 전송하는 동안 다른 어댑터로부터의 신호 에너지가 감지되지 않으면, 프레임 전송을 완료한다. 그러나 전송 도중에 다른 어댑터로부터의 신호에너지를 감지하면, 자신의 프레임 전송을 취소한다.
  - 어댑터는 전송을 취소한 후 임의의 랜덤 시간만큼 기다린 후 2단계로 돌아간다.
- **이진 지수적 백오프(binary exponetial backoff) 알고리즘은 시간 간격을 적절히 지정하는 문제를 효율적으로 해결한다.
- 충돌을 n번 경험한 프레임을 전송할 때 노드는 0 ~ 2^n - 1 중에서 랜덤하게 K 값을 선택한다. 따라서 프레임이 충돌을 더 많이 경험할 수록 K를 선택할 간격을 크게 한다.

#### CSMA/Cd의 효율

- **CSMA/CD의 효율(effciency of CSMA/CD)** 은 오랜 시간 동안 다수의 활성 노드들이 있을 때 충돌 없이 프레임이 채널로 전송되는 시간 비율이다.

### 6.3.3 순번 프로토콜

- **폴링 프로토콜(polling protocol)**
  - 노드 중 하나를 마스터 노드로 지정한다.
  - 마스터 노드는 각 노드를 라운드 로빈 방식으로 **폴링** 한다.
  - 폴링 프로토콜은 충돌뿐만 아니라 랜덤 접속 프로토콜의 단점인 빈 슬롯을 제거함으로써 훨씬 높은 효율을 제공한다.
  - 폴링 프로콜의 단점
    - 폴링 지연(노드가 전송할 수 있음을 알리는데 걸리는 시간)
    - 마스터 노드가 고장 나면 전체 채널이 동작하지 못한다.
- **토큰 전달 프로토콜(token-passing protocol)**
  - **토큰** 이라고 알려진 작은 특수 목적 프레임이 정해진 순서대로 노드 간에 전달된다.
  - 노드가 토큰을 수신하면, 전송할 프레임이 있을 때만 토큰을 붙잡는다. 그렇지 않으면 토큰을 즉시 다음 노드로 전달한다.
  - 토큰을 수신 했을 때 전송할 프레임이 있으면, 프레임을 최대 개수까지 전송한 뒤 토큰을 다음 노드로 전달한다.
  - 토큰 전달은 분산 방식이며 효율이 매우 높다
  - 문제점
    - 노드 하나 실패하면 전체 채널이 동작하지 않는다.
    - 노드가 잘못해서 토큰을 놓아주지 않으면, 토큰이 다시 돌 수 있도록 하는 회복 절차가 시행되어야 한다.

### 6.3.4 DOCSIS : 케이블 인터넷 접속을 위한 링크 계층 프로토콜

- DOCSIS(Data-Over-Cable Service Interface Specifications)는 케이블 데이터 네트워크의 구조와 프로토콜들을 정의한다.
- DOCSIS는 하향(CMTS(Cable Modem Termination System, 케이블 모뎀 종단 시스템)에서 모뎀 방향으로) 및 상향(모뎀에서 CMTS 방향으로) 네트워크 세그먼트들을 다수의 주파수 채널을 나누기 위해 FDM을 사용한다.
- 상향 및 하향 채널은 브로드캐스트 채널이다
- CMTS에 의해 하향 채널로 전송된 프레임은 그 채널을 통해 수신하는 모든 케이블 모뎀에 의해 수신된다.(그러나 하향 채널로 전송하는 CMTS가 하나뿐이기 때문에 다중 접속 문제는 발생하지 않는다.)
- 그러나 상향의 경우 다수의 케이블 모뎀이 CMTS로의 동일한 상향 채널(주파수)을 공유하고 따라서 충돌이 발생할 수 있다.
- 상향 채널은 시간간격으로 나뉘어져 있고 각 시간 간격은 케이블 모뎀이 CMTS로 전송할 수 있는 일련의 미슬롯들로 구성되어 있다.
- CMTS는 개별 케이블 모뎀이 특정 미니슬롯에 전송할 수 있도록 허락한다.
- CMTS는 하향 채널상으로 MAP 메시지로 알려진 제어 메시지를 보냄으로써 어떤 케이블 모뎀이 MAP메시지에서 명시한 시간 간격 동안 어떤 미니슬롯을 ㅗ전송할 수 있는지 알려준다.
- 미니슬롯이 케이블 모뎀마다 명시적으로 할당되기 때문에 CMTS는 미니슬롯 동안은 충돌이 발생하지 않는 것을 확신할 수 있다.
- 케이블 모뎀은 상향 채널의 사용 여부에 대한 감지나 충돌 검출을 수행하지 않는다.
- 대신 케이블 모뎀은 요청된 할당에 대한 응답을 다음 하양 제어 메시지에서 수신하지 못하면 미니 슬롯 요청 프레임이 충돌했다고 추정한다.
- 충돌이 발생한 것으로 추정한 케이블 모뎀은 미슬롯 요청 프레임의 재ㄴ송을 지연시키기 위 이진 지수적 백오프를 사용한다.
- 상향 채널에 트패픽이 거의 없는 경우, 케이블 모뎀은 미니슬롯 요청 프레임을 위해 할당된 슬롯에 데이터 프레임을 전송할 수도 있다.

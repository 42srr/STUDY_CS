# 6 링크 계층과 근거리 네트워크 

## 6.1 링크 계층 소개 

- 노드   --- 링크 --- 노드
- 노드 (node) : 링크 계층 프로토콜을 실행하는 장치
    - (링크 =/= 링크 계층)
- 링크 : 통신 경로상의 인접한 노드들을 연결하는 통신 채널
- 노드가 데이터그램을 링크 계층 프레임으로 캡슐화해서 링크로 전송

### 6.1.1 링크 계층이 제공하는 서비스 

- 기본 서비스 : 한 노드에서 인접 노드로 데이터그램 "이동"
- 다른 서비스도 존재

- 링크 계층 프로토콜이 제공할 수 있는 서비스 
    - 프레임화 
        - 데이터를 프레임이라는 단위로 쪼개서 캡슐화
        - 패킷 => 프레임
        - 프레임 구조는 링크 계층 프로토콜에 의해 명시됨
    - 링크 접속
        - 매체 접속 제어(medium access control, MAC) 프로토콜은 링크상으로 프레임을 전송하는 규칙을 명시 
        - 매체(케이블, 무선)을 누가 언제 사용할지를 조율해주는 규칙
        - EX. 점대점 링크
            - 링크가 비었으면 써
        - EX. 여러 노드
            - MAC 프로토콜은 여러 노드로부터의 프레임 전송을 조정 (다중접속문제)
    - 신뢰적 전달
        - 트랜스포트 계층과 마찬가지로, 링크 계층의 신뢰적 전달 서비스도 확인응답과 재전송을 통해 가능해짐
        - 오류율이 높은 링크에서 주로 사용(ex. 무선 링크)
        - 오류가 발생한 링크에서 오류 정정
        - 오버헤드가 될 수도 있음 (낮은 비트 오류율을 가진 링크에서는)
        - 대다수 링크 프로토콜에서는 신뢰적 전달 서비스를 제공하지 않음
    - 오류 검출과 정정
        - 비트 오류 (1을 0으로, 0을 1로 오해) 검출
        - 아주 일반적인 서비스 
        - 인터넷 체크섬보다 복잡, 하드웨어로 구현됨 
        - 프레임의 어느 곳에서 오류가 발생했는지 정확하게 찾아낼 수 있음 

### 6.1.2 링크 계층이 구현되는 위치

- 일반적인 호스트 구조 
    - 링크 계층은 요즘 대부분 하드웨어(NIC)로 구현, 
      프레임 관련 기능은 NIC 안의 컨트롤러 칩이 전담 
        => why? 링크 계층은 실시간 반응성을 요구하는 계층이기 때문에 
        하드웨어가 소프트웨어보다 빠름 
    - 이더넷 기능 : 마더보드 칩셋에 통합되든지 저가의 이더넷 전용 칩으로 구현
    - 링크 계층 : 대부분의 경우 네트워크 인터페이스 컨트롤러 = NIC = 랜카드
        - 프레임만들고, 오류 검사하고, MAC 주소 확인하는 곳
    - 링크 계층 컨트롤러
        - NIC안에 링크 계층 기능을 처리하는 칩
        - 대부분 하드웨어 


## 6.2 오류 검출 및 정정 기술

- 비트 레벨 오류 검출 및 정정 (bit level error detection and correction)
    - 비트 오류를 방지하기 위해 송신 노드에 데이터 D에 오류 검출 및 정정 비트들(EDC)첨부
    - 수신자는 받은 D'와 EDC'를 가지고 원래의 D와 자기가 받은 D'가 같은지 판단
        - 전송 도중에 비트가 변경될 수 있으므로 
- 향상된 오류 검출 및 정정 기술은 더 많은 오버헤드를 필요로 함
- 세 가지 기술이 유명함 : 패리티 검사, 체크섬, 순환 중복 검사

### 6.2.1 패리티 검사 

- 단일 패리티 비트 사용
    - 패리티 비트(parity bit)를 단순히 하나 추가 
        - 짝수 패리티 검사: 패리티 비트까지 포함해서 값이 1인 비트가 짝수개가 되게끔
        - 홀수 패리티 검사: 패리티 비트까지 포함해서 값이 1인 비트가 홀수개가 되게끔
    - 짝수 패리티 검사 오류
        - 1인 비트가 홀수개면 -> 오류 발생
            - 임의의 홀수개의 비트 오류 발생
    - 홀수 패리티 검사 오류
        - 검출하지 못하는 오류 발생 가능
        - 오류는 홀로 발생하기 보다는 burst 형태로 한꺼번에 몰려서 발생
        - 미검출 오류가 있을 확률은 50%에 이를 수 있음
- 2차원 패리티 기법
    - 패리티 비트를 각 열, 행마다 추가
    - 검사 각 열, 행마다 진행
    - 그럼 어디서 오류가 났는지 파악 가능
    - (개인 의견: 스도쿠 같네연..)
- 순방향 오류 정정 (FEC; forward error correction)
    - 오류를 검출 및 정정하는 수신자의 능력
    - 단독으로 쓰이거나 ARQ기술과 함께 사용 가능
    - 송신자에게 요구하는 재전송 횟수를 줄일 수 있다는 점에서 의의가 있음

### 6.2.2 체크섬 방법

- 체크섬 방법: 쪼개서, 더하고, 그것의 1의 보수를 구한다. 그게 체크섬 값이 되어 수신자가 나중에 데이터와 체크섬을 확인하여 에러가 났는지 안났는지 판단한다.
    - 원본 데이터를 k비트 단위로 쪼갬 
    - 여러개를 더함 => 이 결과의 1의 보수를 구함
    - 1의 보수가 바로 체크섬이 됨
- 패킷 오버헤드가 적음 

### 6.2.3 순환 중복 검사(CRC)

- 기본 연산 : 생성 다항식 G로 modulo-2 나눗셈 수행 
    - 나눠지는 비트 : 데이터 비트 + r개의 값이 0인 비트
    - 나눗셈의 기준: 생성 다항식 G
    - CRC
    - r은 CRC의 차수 (3차면 r = 3)
    - CRC 비트수만큼 앞에 짤라서 연산 -> 한 비트 왼쪽으로 밀고 나머지 비트 한개 가져와서 XOR다시
    - 남은 비트가 없을 때까지 연산
- CRC에서 사용하는 생성 다항식 코드는 정해져 있음. 그 중 하날 골라서 검사
    - ex. CRC-8, CRC-16-CCITT
    - 프로토콜에 의해 결정됨

## 6.3 다중 접속 링크와 프로토콜

- 두 종류의 네트워크 링크
    - 점대점 링크 (PPP, HDLC)
    - 브로드캐스트 링크
- 다중 접속 문제(multiple access problem)
    : 다수의 송수신 노드들의 공유되는 브로드캐스트 채널로의 접속을 조정하는 문제
- 다중 접속 프로토콜
    - 컴퓨터 네트워크에서도 공유되는 
    브로드캐스트 채널로 보내는 노드들의 전송을 조정하기 위한 프로토콜
    - 충돌
        - 수신 노드가 동시에 여러 개의 프레임을 받게 되는 상황
        - 어떤 수신 노드도 전송된 프레임의 의미를 파악할 수 X
        - 브로드캐스트 채널은 충돌 기간만큼 낭비
    - 다중 접속 프로토콜의 종류는 다양
        - 채널 분할 프로토콜, 랜덤 접속 프로토콜, 순번 프로토콜
 
### 6.3.1 채널 분할 프로토콜

- TDM (시분할 다중화 time division multiplexing)
    - 시간을 시간 프레임으로 나누고, 시간 프레임을 또 시간 슬롯으로 나눔
    - 자신에게 할당된 시간 슬롯 동안 패킷 비트 전송
    - 충돌 제거 가능, 공정함
    - 전송할 패킷이 있는 노드가 단 하나인 경우에도 노드 전송률이 R/N으로 제한됨
    - 노드 전송 순서상 자신의 차례를 항상 기다려야 함 

- FDM (주파수 분할 다중화 frequency division multiplexing)
    - 채널을 다른 주파수로 나눠서 각 주파수를 N개 노드 중 하나에게 할당
        - 하나의 큰 R bps 채널로부터 N개의 R/N bps의 작은 채널을 만든다.

- CDMA (코드 분할 다중 접속 code division multiple access)
    - 다른 코드를 각 노드에게 할당
    - 노드는 전송하는 데이터 비트들을 자신의 유일한 코드로 인코딩
    - 동시에 전송도 가능 (코드를 신중하게 고르면)
    - 간섭되더라도 각 수신자들이 송신자의 인코딩된 데이터비트를 정확하게 수신 가능
    - 무선 채널과 밀접하게 연결되어 있음 

### 6.3.2 랜덤 접속 프로토콜 

- 전송 노드는 항상 채널의 최대 전송률인 R bps로 전송함
- 충돌이 생기면 랜덤 지연 시간 동안 기다리고 프레임 재전송

##### 슬롯 알로하
- 모든 프레임은 정확히 l비트로 구성된다.
- 시간은 l/r초의 슬롯들로 나뉜다. (즉, 한 슬롯은 한 프레임 전송에 걸리는 시간과 같다).
- 노드는 슬롯의 시작점에서만 프레임을 전송하기 시작한다.
- 각 노드는 언제 슬롯이 시작하는지 알 수 있게끔 동기화되어 있다.
- 한 슬롯에서 2개 이상의 프레임이 충돌하면, 모든 노드는 그 슬롯이 끝나기 전에 충돌 발생을 알게 된다. 
- 노드는 전송할 새 프레임이 있으면 다음 슬롯이 시작할 때까지 기다렸다가 그 슬롯에 전체 프레임을 전송한다.

- 동기화 관련
    - 슬롯 시간을 다 알고 있다는 측면에서
- 분산
    - 중앙 통제자가 없고 각 노드가 알아서 판단해서 보낸다는 측면에서

##### 알로하 
- 모든 노드가 슬롯의 시작점에서 전송을 시작할 수 있도록 동기화되어 있기를 요구
- 슬롯 없음 => 시간 알아서 지연시킨 다음에 재전송
- 완전히 분산된 알로하 프로토콜
- 최대 효율도 슬롯 알로하의 절반

##### CSMA
- 캐리어 감지
    - 전송하기 전에 채널 감지
    - 전송 중단이 임의의 짧은 시간동안 감지되면 프레임 전송
- 충돌 검출
    - 송신 노드는 전송하면서 동시에 채널 감지
    - 충돌 발생시 랜덤 시간동안 기다린 후 유휴 시 감지 및 전송 과정 반복 

- 얼핏보면 충돌이 일어나지 않아 보이지만 채널 전파 지연때문에 충돌이 일어날 수 있음

##### CSMA/CD 
- 랜덤 백오프
    - 이진 지수적 백오프 : 충돌 횟수가 늘어날수록 대기시간도 이진수 기반으로 지수 증가

### 6.3.3 순번 프로토콜

- 폴링 프로토콜(polling protocol)
    - 마스터 노드가 있음 (노드 중 하나)
    - 마스터 노드는 각 노드를 라운드 로빈 방식으로 폴링함
        - 폴링 : 다른 노드들에게 기회를 한번씩 줌 (전달할게 있니?)
        - 라운드 로빙 : 순서를 정해놓고 돌아가면서 차례차례 기회를 주는 방식 
    - 마스터 노드가 모든 걸 결정
    - 마스터 노드는 노드에게 먼저 최대로 보낼 수 있는 프레임 수에 대한 정보를 보냄
    - 신호가 없으면 다음 노드로  ㄱ ㄱ 
    - 마스터 노드가 순서랑 양을 조절
    - 오버헤드

- 토큰 전달 프로토콜(token passing protocol)
    - 마스터 노드 없음
    - 토큰 : 작은 특수 목적 프레임이 정해진 순서대로 노드 간에 전달
    - 노드가 토큰을 숫니하면 전송할 프레임이 있을 때만 토큰을 붙잠음
        - 아니면 즉시 다음 노드로 토큰 전달
    - 토큰 가진 애만 말할 수 있다.. 
    - 분산 방식, 효율이 높음

### 6.3.4 DOCSIS: 케이블 인터넷 접속을 위한 링크 계층 프로토콜

- CMTS(Cable Modem Termination System) : 중앙 통제 타워 느낌 
- 상향 채널, 하향 채널
    - 하향 채널 : 브로드캐스트
    - 상향 채널 : 다수 사용자 전송, 충돌 가능성 존재 
        - 누가 언제 전송할지 중앙타워가 컨트롤

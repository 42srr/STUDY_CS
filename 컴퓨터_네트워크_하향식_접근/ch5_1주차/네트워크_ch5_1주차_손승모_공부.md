# 네트워크 계층 : 제어 평면

## 5.1 개요

- 라우터별 제어

  - 포워딩과 라우팅 기능이 모두 개별 라우터에 포함되어 있다.
  - 각 라우터는 다른 라우터의 라우팅 구성요소와 통신하여 자신의 포워딩 테이블의 값을 계산하는 라우팅 구성요소를 갖고 있다.
- 논리적 중앙 집중형 제어

  - 일반화된 '매치 플러스 액션(match plus action)' 추상화를 통해 라우터는 기존에는 별도의 장치로 구현되었던 다양한 기능 (부하 분산, 방화벽, NAT) 뿐만 아니라 전통적인 IP 포워딩을 수행할 수 있다.
- 컨트롤러는 잘 정의된 프로토콜을 통해 각 라우터의 제어 에이전트(contorl agent, CA)와 상호작영하여 라우터의 플로우 테이블을 구성 및 관리한다.
- '논리적 중앙 집중형' 제어란 실제로는 고장 또는 참여 호스트 수의 증가에 따른 성능 저하 문제에 대응하기 위해 여러 개의 서버에 라팅 서비스가 구현된다 하더라도 마치 하나의 중앙 서비스 지점에 있는 것처럼 서비스에 접근한다는 의미다.

## 5.2 라우팅 알고리즘

- 라우팅 알고리즘의 목표는 송신자부터 수신자까지 라우터의 네트워크를 통과하는 좋은 경로를 결정하는 것이다.
- 라우팅 알고리즘을 분류하는 일반적인 방법 한 가지는 알고리즘이 중앙 집중형인지 분산형인지다.
- **중앙 집중형 라우팅 알고리즘(centralized routing algorithm)**
  - 네트워크 전체에 대한 완전한 정보를 가지고 출발지와 목적지 사이의 최소 비용 경로를 계산한다.
  - 즉 이 알고리즘은 모든 노드 사이의 연결 상태와 링크 비용을 입력값으로 한다.
  - 이 알고리즘이 연결과 링크 비용에 대한 완전한 정보를 갖는 다는 점이다.
  - 전체 상태 정보를 갖는 알고리즘을 **링크 상태(link-state, LS) 알고리즘** 이라고 한다.
- **분산 라우팅 알고리즘(decentralized routing algorithm)**
  - 최소 비용 경로의 계산이 라우터들에 의해 반복적이고 분산된 방식으로 수행된다.
  - 어떤 노드도 모든 링크의 비용에 대한 완전한 정보를 갖고 있지는 않다.
  - 대신 각 노드는 자신에게 직접 연결된 링크에 대한 비용 정보만을 가지고 시작한다.
  - 이후 반복된 계산과 이웃 노드와의 정보 교환을 통해 노드는 점차적으로 목적지 또는 목적지 집합까지의 최소 비용 경로를 계산한다.
  - 분산 라우팅 알고리즘은 거리 벡터(distance-vector, DV) 알고리즘이라고 부른다.
  - 이는 각 노드가 네트워크 내 다른 모든 노드끼리 비용(거리)의 추정값을 벡터 형태로 유지하기 때문이다.
- 라우팅 알고리즘을 분류하는 일반적인 두 번째 방식은 정적 알고리즘과 동적 알고리즘으로 분류하는 것이다.
- **정적 라우팅 알고리즘(static routing algorithm)** 에서 경로는 아주 느리게 변하는데, 종종 사람이 개입(예를 들면, 사람이 직접 링크 비용을 수정하는 경우)한 결과로 그렇게 된다.
- **동적 라우팅 알고리즘(dynamic routing algorithm)** 은 네트워크 트래픽 부하(load)나 토폴로지 변화에 따라 라우팅 경로를 바꾼다. 동적 알고리즘은 주기적으로, 혹은 토폴로지나 링크 비용의 변경에 직접적으로 응답하는 방식으로 수행된다.
- 라우팅 알고리즘은 분류하는 데 세 번째 방식은 라우팅 알고리즘이 부에 민감한지 아닌지에 따른다. **부하에 민감한 알고리즘(load-sensitive algorithm)** 에서 링크 비용은 해당 링크의 현재 혼잡 수준을 나타내기 위해 동적으로 변한다.
- 오늘날 인터넷 라우팅 알고리즘은 **(RIP, OSPF, BGP 등)** 은 링크 비용이 현재 (또는 가장 최근)의 혼잡을 반형하지 않기 때문에 **부하에 민감하지 않다**

### 5.2.1 링크 상태(LS) 라우팅 알고리즘

- 링크 상태 알고리즘에서는 네트워크 토폴리조아 모든 링크 비용이 알려져 있어서 링크 상태 알고리즘의 입력값으로 사용될 수 있다는 점을 기억
- 모든 노드들이 주기적으로 자신의 link state를 broadcast한다.
- 이것은 각 노드가 자신과 직접 연결된 링크의 식별자와 비용 정보를 담은 링크 상태 패킷을 네트워크상의 다른 모든 노드로 브로드캐스트하게 함으로써 가능하다.
- 다익스트라 알고리즘 (Dijkstra's algorithm)
- 반복 수행이 종료되면 알고리즘은 출발지 노드에서 네트워크 상의 다른 모든 노드로의 최단 경로를 산출할 수 있다.
- 진동(oscillation)문제(진동 문제는 네트워크 토폴로지 정보가 불안정하게 변화하면서 발생하는 문제, 링크 상태 알고리즘뿐만 아니라 혼잡이나 지연 시간을 기반으로 링크 비용을 산출하는 모든 알고리즘에서 발생할 수 있다)를 방지하려면 어떻게 해야할까?
  - 링크 비용이 해당 링크가 전달하는 트래픽의 양에 의존하지 않도록 하는 방법
    - 라우팅의 한 가지 목적이 매우 혼잡한 (즉, 높은 지연을 발생시키는) 링크를 회피하는 것이므로 받아들이기 어려운 해결책이다.
  - 모든 라우터가 동시에 링크 상태 알고리즘을 실행하지 못하도록 하면 된다.
    - 각 노드에서의 알고리즘의 실행 시각은 같지 않을 것
  - 흥미롭게도 연구자들은 인터넷 라우터들이 스스로 자기들끼리 동기를 맞춘다는 사실을 발견했다.
  - 즉 라우터들이, 알고리즘을 처음에는 각기 다른 시작 시각에, 그러나 같은 주기를 갖도록 해서 실행하더라도 점진적으로 결국엔 서로 동기화된다는 것이다.
  - 이러한 자기 동기화는 각 노드가 링크 상태 정보를 송신하는 시각을 임의로 결정하게 함으로써 회피할 수 있다.

### 5.2.2 거리 벡터(DV) 라우팅 알고리즘

- 자신과 물리적으로 연결된 router 정보만 안다.
- **거리 벡터(distance-vector DV)** 알고리즘은 반복적이고 비동기적이며 분산적이다.
- 각 노드는 하나 이상의 **직접 연결된** 이웃으로부터 정보를 받고 계산을 수행하며 계산된 결과를 다시 그 이웃들에게 배포한다는 점에서 **분산적**이다.
- 이웃끼리 더 이상 정보를 교환하지 않을 때까지 프로세스 지속된다는 점에서 **반복적**이다.
- 톱니바퀴 돌듯이 모든 노드가 서로 정확히 맞물려 동작할 필요가 없다는 점에서 **비동기적**이라고 할 수 있다.
- 최소 비용은 **벨만-포드(Bellman-Ford)식**에 의해 계산된다.
- 결국 DV 알고리즘은 계속 재귀적으로 뒤에 부분을 전달해줘야 한다. 즉 모든 노드들이 풀려야 한다.

#### 거리 벡터(DV) 알고리즘

- Action의 조건

  - 인접한 node의 cost 변경
  - 인접한 node의 distance vector 정보 수신
- 이러한 상황이 발생한 경우 자신의 distance vector 계산 후 정보값이 달라지면 주변에 전달한다.
- LS 알고리즘은 다익스트라 알고리즘을 수행하기 전에 각 노드가 네트워크에 대한 전체 지도를 먼저 얻어야 한다는 면에서 중앙 집중형 알고리즘
- DV알고리즘은 분산적이고 그러한 전체 정보를 사용하지 않는다.
- DV의 유사 알고리즘은 실제로 인터넷의 **RIP, BGP, ISO, IDRP, Novell IPX** , 최초의 **ARPAnet** 등을 포함하여 많은 라우팅 알고리즘에서 사용된다.

#### 거리 벡터(DV) 알고리즘 : 링크 비용 변경과 링크 고장

- **라우팅 루프(routing loop)** 가 발생할 수 있다.
  - 네트워크에서 패킷이 목적지에 도달하지 못하고 동일한 라우터들 사이를 계속 순환하는 현상

#### 거리 벡터 알고리즘 : 포이즌 리버스 추가

- **포이즌 리버스(poisoned reverse)** 라는 방법을 사용해 방지할 수 있다.
- 경유해서 가면 무조건 무한대로 알리는 방식.
- 특정 인터페이스로 학습한 경로를 같은 인터페이스로 다시 광고할 때 무한대 거리(도달 불가능)로 표시
- (단순히 직접 이웃한 2개의 노드가 아닌) 3개 이상의 노드를 포함한 루프는 포이즌 리버스로는 감지할 수 없다.

#### 링크 상태 알고리즘과 거리 벡터 라우팅 알고리즘의 비교

- 어떤 알고리즘이 다른 알고리즘보다 명백히 낫다고 말할 수 없다.

## 5.3 인터넷에서의 AS 내부 라우팅 : OSPF

- 확장
  - 라우터의 수가 증가함에 따라 라우팅 정보의 통신, 계산, 저장에 필요한 오버헤드가 걷잡을 수 없이 증가한다.
- 관리 자율성
  - 하나의 조직은 자신의 네트워크를 외부 네트워크에 연결하면서도 자신이 원하는 대로 네트워크를 운영하고 관리할 수 있어야 한다.
- 이 두 가지 문제는 라우터들은 **자율 시스템(Autonomous System, AS)** 으로 조직화하여 해결할 수 있다.
- 각 AS는 동일한 관리 제어하에 있는 라우터의 그룹으로 구성된다.
- 자율 시스템은 전 세계적으로 고유한 AS 번호 (autonomous system number, ASN)로 식별된다.
- 같은 AS 안에 있는 라우터들은 동일한 라우팅 알고리즘을 사용하고 상대방에 대한 정보를 갖고 있다.
- 자ㄹ 시스템 내부에서 동작하는 라우팅 알고리즘은 **AS 내부 라우팅 프로토콜 (intra-autonomous system routing protocol)** 이라고 한다.

#### 개방형 최단 경로 우선(OSPF) 프로토콜

- Open Shortest Path First Protocol
- OSPF는 링크 상태 정보를 플러딩(flooding)하고 다익스트라 최소 비용 경로 알고리즘으 사용하는 링크 상태 알고리즘이다.
- 각 라우터는 자신을 루트 노드로 두고 모든 서브넷에 이르는 최단 경로 트리를 결정하기 위해 혼자서 다익스트라의 최단 경로 알고리즘을 수행한다.
- OSPF를 사용하는 라우터는 인접한 라우터만이 아니 자율 시스템 내의 다른 모든 라우터에게 라우팅 정보를 브로드캐스팅한다.
- OSPF 프로토콜은 신뢰할 수 있는 메시지 전송과 링크 상태의 브로드캐스트와 같은 기능을 구현해야 한다.
- OSPF에 구현된 개선사항들
  - 보안
  - 복수 동일 비용 경로
  - 유니캐스트와 멀티캐스트 라우팅의 통합 지원
  - 단일 AS 내에서의 계층 지원

## 5.4 인터넷 서비스 제공업자 (ISP) 간의 라우팅 : BGP

- 동일한 AS 내에 있는 출발지와 목적지 사이에서 패킷을 라우팅할 때, 패킷이 전송되는 경로는 전적으로 AS 내부 라우팅 프로토콜에 의해 결정된다.
- **자율 시스템 간 라우팅 프로토콜(inter-autonomous system routing protocol)** 이 필요하다.
- AS 간 라우팅 프로토콜은 여러 AS 간의 협력이 수반되므로 통신하는 AS들은 같은 AS 간 라우팅 프로토콜을 수행해야만 한다.
- 인터넷의 모든 AS 는 경계 게이트웨이 프로토콜(Border Gateway Protocol)이라고 불리는 동일한 AS간 라우팅 프로토콜을 사용한다.
- BGP라고 잘 알려져 있다.
- inter As -> 제일 돈이 덜 드는, 돈이 되는 경로로 보내줌.

### 5.4.1 BGP의 역할

- BGP에서는 패킷이 특정한 목적지 주소를 향해서가 아니라 **CIDR(Classless Inter Domain Routing)** 형식으로 표현된, 주소의 앞쪽 프리픽스(prefix)를 행햐 전달된다.
- AS 간 라우팅 프로토콜로서 BGP는 각 라우터에게 다음과 같은 수단을 제공한다.
  - 이웃 AS를 통해 도달 가능한 서브넷 프리픽스 정보를 얻는다
  - 서브넷 주소 프리픽스로의 가장 좋은 경로를 결정한다.

### 5.4.2 BGP 경로 정보 알리기

- 자신까지 도달할 수 있는 AS 정보를 주기적으로 advertise함
- 각 AS에서 각각의 라우터들은 **게이트웨이 라우터(gateway router)** 또는 **내부 라우터(internal router)다.

### 5.4.3 최고의 경로 결정

- 라우터가 BGP 연결을 통해 주소 프리픽스를 알릴 때 몇몇 BGP 속성(attribute)을 함께 포함한다.
- BGP의 용어로는 프리픽스와 그것의 속성을 경로라고 한다.
- 특히 중요한 속성 두 가는 AS-PATH와 NEXT-HOP이다.
- AS-PATH 값을 생성하기 위해 프리픽스가 어떤 AS에 전달되었을 때 그 AS는 자신의 ASN을 AS-PATH 내 현재 리스트에 추가한다.
- BGP 라우터는 AS-PATH 속성을 메시지의 루프를 감지하고 방지하기 위해 활용한다.
- NEXT-HOP은 AS-PATH가 시작되는 라우터 인터페이스의 IP 주소다.

#### 뜨거운 감자 라우팅

- 뜨거운 감자 라우팅에 깔려 있는 기본 아이디어는 라우터가 목적지까지의 경로 중 자신의 AS 바깥에 있는 부분에 대한 비용은 신경 쓰지 않고 최대한 신속하게 (좀 더 정확하게는, 가능한 한 최소의 비용으로) 패킷을 자신의 AS 밖으로 내보내는 것이다.

#### 경로 선택 알고리즘

### 5.4.4 IP 애니캐스트

- IP 애니캐스트(Anycast)는 동일한 IP 주소를 여러 서버나 네트워크 장치에 할당하는 네트워킹 기술
- 이 기술을 통해 클라이언트는 지리적으로 가장 가깝거나 네트워크 상황이 가장 좋은 서버로 자동 연결된다.

### 5.4.5 라우팅 정책

- 라우터가 목적지까지의 경로를 선택하려 할 때 AS 라우티 정책은 최단 AS-PATH나 뜨거운 감자 라우팅 등의 다른 모든 고려사항보다 우선시된다.
- 기밀이 많다.

### 5.4.6 조각 맞추기 : 인터넷 존재 확인하기
